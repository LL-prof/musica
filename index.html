<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Lectura musical</title>

<style>
:root{
  --bg:#10131a;
  --shadow:0 14px 36px rgba(0,0,0,.35);
  --yellow:rgba(180,140,0,.35);
  --ok:#25c26e;
  --card:rgba(255,255,255,.06);
}

*{box-sizing:border-box}
body{
  margin:0;
  background:radial-gradient(1200px 700px at 30% 10%, #20283a 0%, var(--bg) 60%, #070a11 100%);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  min-height:100vh;
}
.wrap{
  width:min(980px, 100%);
  margin:0 auto;
  padding:14px;
  display:grid;
  gap:14px;
}
.panel{
  background:var(--card);
  border-radius:18px;
  box-shadow:var(--shadow);
  overflow:hidden;
}
.rowTop{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding:14px;
}
.title{
  color:#fff;
  font-weight:900;
  margin:0;
  font-size:18px;
  letter-spacing:.3px;
  user-select:none;
}
.controls{
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:flex-end;
  flex-wrap:wrap;
}
.ctrlBtn{
  width:56px;height:46px;border-radius:14px;
  border:2px solid rgba(255,255,255,.35);
  background:rgba(255,255,255,.06);
  color:#fff;
  cursor:pointer;
  font-weight:900;
  transition:.12s;
}
.ctrlBtn:hover{ background:rgba(255,255,255,.10); }
.ctrlBtn:active{ transform:scale(.98); }
.ctrlBtn[disabled]{ opacity:.28; cursor:not-allowed; }

.modeBtn{
  width:72px;
  background:#fff;
  color:#111;
  border-color:#bbb;
}
.modeBtn.active{
  box-shadow:0 0 0 4px rgba(37,194,110,.20);
  border-color:rgba(37,194,110,.6);
}

/* Play del alumno: rojo -> verde cuando 4/4 */
.childBtn{
  border-color:#c0392b;
  background:#ffecec;
  color:#111;
}
.childBtn:hover{ background:#ffdede; }
.childBtn.ok{
  border-color: var(--ok);
  background:#eafff1;
}
.childBtn.ok:hover{ background:#dbffea; }

.sheet{
  background:#fff;
  border-radius:16px;
  padding:12px;
  margin:14px;
}
.stage{ position:relative; }
svg{ width:100%; height:auto; display:block; }

/* ref m√°s peque√±o */
.refWrap{
  width:60%;
  margin:0 auto;
}

.pool{
  display:flex;
  justify-content:center;
  gap:12px;
  margin:10px 14px 16px;
  flex-wrap:wrap;
  min-height:100px;
}
.token{
  width:96px;height:104px;
  background:#111;color:#fff;
  border-radius:18px;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:8px;
  cursor:grab;
  user-select:none;
  touch-action:none;
  box-shadow:0 10px 18px rgba(0,0,0,.25);
}
.token.locked{ opacity:.28; cursor:default; }
.token svg{ width:34px; height:34px; display:block; }

/* marcador verde */
.marker{
  position:absolute;
  width:38px;height:38px;border-radius:12px;
  background:rgba(37,194,110,.25);
  border:2px solid rgba(37,194,110,.7);
  transform:translate(-50%,-50%);
  pointer-events:none;
}

/* Altavoz overlay */
.speaker{
  position:absolute;
  inset:0;
  display:grid;
  place-items:center;
  pointer-events:none;
  opacity:0;
  transition:opacity .15s ease;
}
.speaker.show{ opacity:1; }
.speaker .bubble{
  width:120px;height:120px;border-radius:32px;
  background:rgba(255,255,255,.88);
  box-shadow:var(--shadow);
  display:grid;
  place-items:center;
  backdrop-filter:blur(6px);
}
.speaker svg{ width:66px;height:66px; }

/* banda amarilla "flash" al acertar */
.bandFlash{
  animation: bandFlash .22s ease-in-out 0s 2;
}
@keyframes bandFlash{
  0%   { opacity:1; transform:scaleX(1); }
  50%  { opacity:.25; transform:scaleX(.98); }
  100% { opacity:1; transform:scaleX(1); }
}

.hintBar{
  height:8px;
  width:100%;
  background:rgba(255,255,255,.08);
}
</style>
</head>

<body>
  <div class="wrap">
    <div class="panel">

      <!-- CABECERA -->
      <div class="rowTop">
        <p class="title" id="lvlTitle">Nivel 1</p>

        <div class="controls" aria-label="Controles">
          <!-- Modo duraci√≥n SOLO PARA REFERENCIA -->
          <button class="ctrlBtn modeBtn active" id="btnNegra" aria-label="Referencia negra">N</button>
          <button class="ctrlBtn modeBtn" id="btnBlanca" aria-label="Referencia blanca">B</button>

          <!-- Escuchar objetivo (SIEMPRE NEGRAS en el ejercicio) -->
          <button class="ctrlBtn" id="btnListen" aria-label="Escuchar objetivo">‚ñ∂</button>

          <!-- Escuchar lo que llevo (SIEMPRE NEGRAS) -->
          <button class="ctrlBtn childBtn" id="btnChild" aria-label="Escuchar lo que llevo">‚ñ∂</button>

          <!-- Siguiente (bloqueado hasta acertar) -->
          <button class="ctrlBtn" id="btnNext" aria-label="Siguiente" disabled>‚Üí</button>
        </div>
      </div>
      <div class="hintBar"></div>

      <!-- ARRIBA: ESCALA DE REFERENCIA -->
      <div class="sheet">
        <div class="stage refWrap" id="refStage">
          <svg viewBox="0 0 760 260" id="refSvg" aria-label="Escala de referencia">
            <g stroke="#000" stroke-width="2">
              <line x1="40" y1="60"  x2="720" y2="60"/>
              <line x1="40" y1="85"  x2="720" y2="85"/>
              <line x1="40" y1="110" x2="720" y2="110"/>
              <line x1="40" y1="135" x2="720" y2="135"/>
              <line x1="40" y1="160" x2="720" y2="160"/>
            </g>
            <text x="54" y="135" font-size="56">ùÑû</text>

            <g id="refNotes"></g>
            <g id="refNames"></g>
          </svg>

          <div class="speaker" id="speakerRef" aria-hidden="true">
            <div class="bubble">
              <svg viewBox="0 0 64 64" fill="none">
                <path d="M28 22L18 30H10v4h8l10 8V22z" fill="#111827"/>
                <path d="M40 24c3 3 3 13 0 16" stroke="#4aa3ff" stroke-width="4" stroke-linecap="round"/>
                <path d="M48 18c6 6 6 22 0 28" stroke="#4aa3ff" stroke-width="4" stroke-linecap="round" opacity=".75"/>
              </svg>
            </div>
          </div>
        </div>
      </div>

      <!-- ABAJO: NIVEL ACTUAL -->
      <div class="sheet">
        <div class="stage" id="levelStage">
          <svg viewBox="0 0 760 280" id="lvlSvg" aria-label="Pentagrama del nivel">
            <g stroke="#000" stroke-width="2">
              <line x1="40" y1="80"  x2="720" y2="80"/>
              <line x1="40" y1="105" x2="720" y2="105"/>
              <line x1="40" y1="130" x2="720" y2="130"/>
              <line x1="40" y1="155" x2="720" y2="155"/>
              <line x1="40" y1="180" x2="720" y2="180"/>
            </g>
            <text x="54" y="155" font-size="56">ùÑû</text>

            <!-- banda amarilla -->
            <g id="bandG"></g>

            <!-- notas colocadas -->
            <g id="placedG"></g>
          </svg>

          <div class="speaker" id="speakerLvl" aria-hidden="true">
            <div class="bubble">
              <svg viewBox="0 0 64 64" fill="none">
                <path d="M28 22L18 30H10v4h8l10 8V22z" fill="#111827"/>
                <path d="M40 24c3 3 3 13 0 16" stroke="#4aa3ff" stroke-width="4" stroke-linecap="round"/>
                <path d="M48 18c6 6 6 22 0 28" stroke="#4aa3ff" stroke-width="4" stroke-linecap="round" opacity=".75"/>
              </svg>
            </div>
          </div>
        </div>

        <div class="pool" id="pool" aria-label="Fichas"></div>
      </div>

    </div>
  </div>

<script>
/* =========================================================
   ‚úÖ AUDIO MP3
   ========================================================= */
const AUDIO_FOLDER = ""; // <-- CAMBIA AQU√ç si los mp3 est√°n en una carpeta

const SAMPLES = {
  do:  { white: AUDIO_FOLDER + "do_blanca.mp3",  black: AUDIO_FOLDER + "do_negra.mp3"  },
  re:  { white: AUDIO_FOLDER + "re_blanca.mp3",  black: AUDIO_FOLDER + "re_negra.mp3"  },
  mi:  { white: AUDIO_FOLDER + "mi_blanca.mp3",  black: AUDIO_FOLDER + "mi_negra.mp3"  },
  fa:  { white: AUDIO_FOLDER + "fa_blanca.mp3",  black: AUDIO_FOLDER + "fa_negra.mp3"  },
  sol: { white: AUDIO_FOLDER + "sol_blanca.mp3", black: AUDIO_FOLDER + "sol_negra.mp3" },
  la:  { white: AUDIO_FOLDER + "la_blanca.mp3",  black: AUDIO_FOLDER + "la_negra.mp3"  },
  si:  { white: AUDIO_FOLDER + "si_blanca.mp3",  black: AUDIO_FOLDER + "si_negra.mp3"  },
};

/* =========================================================
   MAPEO VISUAL (Y) del EJERCICIO (viewBox 280)
   ========================================================= */
const MAP = {
  do:  { y:232, ledgerLines:2 },
  re:  { y:220, ledgerLines:0 },
  mi:  { y:208, ledgerLines:0 },
  fa:  { y:196, ledgerLines:0 },
  sol: { y:184, ledgerLines:0 },
  la:  { y:172, ledgerLines:0 },
  si:  { y:160, ledgerLines:0 },
};
const SCALE = ["do","re","mi","fa","sol","la","si"];

/* =========================================================
   ‚úÖ MAPE0 PERFECTO PARA REFERENCIA (sin ‚Äú-30‚Äù ni escalado raro)
   Convertimos la y del EJERCICIO a "pasos" (l√≠nea/espacio) y
   reconstruimos la y en el pentagrama de REFERENCIA.
   - Ejercicio: l√≠neas en 80..180 (l√≠nea inferior=180)
   - Referencia: l√≠neas en 60..160 (l√≠nea inferior=160)
   - gap=25 => step=12.5
   ========================================================= */
const EX_BOTTOM_LINE = 180;
const EX_LINE_GAP = 25;
const EX_STEP = EX_LINE_GAP / 2; // 12.5

const REF_BOTTOM_LINE = 160;
const REF_LINE_GAP = 25;
const REF_STEP = REF_LINE_GAP / 2; // 12.5

function refY(sol){
  const yEx = MAP[sol].y;

  // cu√°ntos "pasos" (12.5) hay desde la l√≠nea inferior del ejercicio hasta la nota
  const stepsFromBottom = (EX_BOTTOM_LINE - yEx) / EX_STEP;

  // reconstruimos esa misma posici√≥n relativa en la referencia
  return REF_BOTTOM_LINE - stepsFromBottom * REF_STEP;
}

/* =========================================================
   NIVELES
   ========================================================= */
const LEVELS = [
  ["do","re","mi","sol"],
  ["do","mi","sol","fa"],
  ["re","mi","fa","sol"],
  ["mi","re","do","sol"],
  ["sol","fa","mi","re"],
  ["do","re","fa","sol"],
  ["re","fa","sol","la"],
  ["mi","fa","sol","la"],
  ["sol","la","si","do"],
  ["la","si","do","re"],
];

/* =========================================================
   SVG helpers
   ========================================================= */
function ledgerLinesSVG(linesCount){
  if(!linesCount) return "";
  let out = "";
  const spacing = 12; // lo mantenemos como lo ten√≠as (visual)
  for(let i=0;i<linesCount;i++){
    const yy = i * spacing;
    out += `<line x1="-22" y1="${yy}" x2="22" y2="${yy}" stroke="#000" stroke-width="2"/>`;
  }
  return out;
}

function noteSVG(x,y,ledgerLines){
  return `
  <g class="placedNote" transform="translate(${x},${y})" data-x="${x}" data-y="${y}">
    ${ledgerLinesSVG(ledgerLines)}
    <ellipse rx="12" ry="9" fill="#000" transform="rotate(-18)"/>
    <line x1="10" y1="-2" x2="10" y2="-50" stroke="#000" stroke-width="3"/>
  </g>`;
}

/* =========================================================
   ‚úÖ Anti-solape
   ========================================================= */
let ctx = null;
let isPlaying = false;
let activeSources = [];
const bufferCache = new Map();

function getAudioContext(){
  if(!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
  if(ctx.state === "suspended") ctx.resume();
  return ctx;
}

async function loadBuffer(url){
  if(bufferCache.has(url)) return bufferCache.get(url);
  const res = await fetch(url);
  if(!res.ok) throw new Error("No se pudo cargar: " + url);
  const arr = await res.arrayBuffer();
  const ac = getAudioContext();
  const buf = await ac.decodeAudioData(arr);
  bufferCache.set(url, buf);
  return buf;
}

function stopPlayback(){
  activeSources.forEach(s => { try{ s.stop(0); }catch(e){} });
  activeSources = [];
  isPlaying = false;
  hideSpeakerAll();
}

function playBufferAt(buffer, startTime, gainValue=1.0){
  const ac = getAudioContext();
  const src = ac.createBufferSource();
  const gain = ac.createGain();
  src.buffer = buffer;
  gain.gain.setValueAtTime(gainValue, startTime);
  src.connect(gain).connect(ac.destination);
  activeSources.push(src);
  src.onended = () => { activeSources = activeSources.filter(x => x !== src); };
  src.start(startTime);
  return buffer.duration;
}

/* =========================================================
   Modo duraci√≥n:
   - REFERENCIA: usa MODE ("black"/"white")
   - EJERCICIO: SIEMPRE "black"
   ========================================================= */
let MODE = "black";
const btnNegra = document.getElementById("btnNegra");
const btnBlanca = document.getElementById("btnBlanca");

btnNegra.addEventListener("click", () => {
  MODE = "black";
  btnNegra.classList.add("active");
  btnBlanca.classList.remove("active");
});
btnBlanca.addEventListener("click", () => {
  MODE = "white";
  btnBlanca.classList.add("active");
  btnNegra.classList.remove("active");
});

/* =========================================================
   Speakers
   ========================================================= */
const speakerRef = document.getElementById("speakerRef");
const speakerLvl = document.getElementById("speakerLvl");

function showSpeaker(el){ el.classList.add("show"); }
function hideSpeaker(el){ el.classList.remove("show"); }
function hideSpeakerAll(){ hideSpeaker(speakerRef); hideSpeaker(speakerLvl); }

/* =========================================================
   Play NOTE / SEQUENCE
   ========================================================= */
async function playNote(name, speakerEl, reference=false){
  stopPlayback();
  isPlaying = true;
  showSpeaker(speakerEl);

  const kind = reference ? MODE : "black";
  const url = SAMPLES[name]?.[kind];
  if(!url) throw new Error("Falta sample para " + name + " (" + kind + ")");

  const buf = await loadBuffer(url);
  const ac = getAudioContext();
  const t0 = ac.currentTime + 0.03;
  const dur = playBufferAt(buf, t0, 1.0);

  setTimeout(() => {
    hideSpeaker(speakerEl);
    isPlaying = false;
  }, (dur * 1000) + 120);
}

async function playSequence(names, speakerEl, reference=false){
  if(isPlaying) return;

  stopPlayback();
  isPlaying = true;
  showSpeaker(speakerEl);

  const kind = reference ? MODE : "black";
  const urls = names.map(n => SAMPLES[n]?.[kind]).filter(Boolean);
  const buffers = [];
  for(const u of urls) buffers.push(await loadBuffer(u));

  const ac = getAudioContext();
  let t = ac.currentTime + 0.05;
  const GAP = 0.08;

  for(const buf of buffers){
    const d = playBufferAt(buf, t, 1.0);
    t += d + GAP;
  }

  const totalMs = (t - ac.currentTime) * 1000 + 160;
  setTimeout(() => {
    hideSpeaker(speakerEl);
    isPlaying = false;
  }, totalMs);
}

/* =========================================================
   ARRIBA: Referencia (clicable) + nombres debajo
   ========================================================= */
const refNotes = document.getElementById("refNotes");
const refNames = document.getElementById("refNames");

SCALE.forEach((s,i)=>{
  const x = 170 + i*80;
  const y = refY(s);

  const g = document.createElementNS("http://www.w3.org/2000/svg","g");
  // ‚úÖ misma nota pero con y calculada "perfecta"
  g.innerHTML = noteSVG(x, y, MAP[s].ledgerLines);
  g.style.cursor = "pointer";
  g.addEventListener("pointerdown", (e) => {
    e.preventDefault();
    playNote(s, speakerRef, true).catch(console.error);
  });
  refNotes.appendChild(g);

  refNames.insertAdjacentHTML("beforeend",
    `<text x="${x-14}" y="248" font-size="16" font-weight="900">${s}</text>`
  );
});

/* =========================================================
   ABAJO: Nivel actual
   ========================================================= */
const lvlTitle = document.getElementById("lvlTitle");
const btnListen = document.getElementById("btnListen");
const btnChild  = document.getElementById("btnChild");
const btnNext   = document.getElementById("btnNext");

const bandG = document.getElementById("bandG");
const placedG = document.getElementById("placedG");
const levelStage = document.getElementById("levelStage");
const pool = document.getElementById("pool");

let levelIndex = 0;
let target = null;
let placed = [];
let tokenIdx = 0;

const SLOT_X = [300, 390, 480, 570];

function showBand(sol, flash=false){
  bandG.innerHTML = "";
  if(!sol) return;

  const y = MAP[sol].y;
  const rect = document.createElementNS("http://www.w3.org/2000/svg","rect");
  rect.setAttribute("x","40");
  rect.setAttribute("y", String(y - 9));
  rect.setAttribute("width","680");
  rect.setAttribute("height","18");
  rect.setAttribute("rx","6");
  rect.setAttribute("fill", getComputedStyle(document.documentElement).getPropertyValue("--yellow").trim() || "rgba(180,140,0,.35)");
  if(flash) rect.classList.add("bandFlash");
  bandG.appendChild(rect);
}

function nearestSolByY(y){
  let best=null, bestD=Infinity;
  for(const k of SCALE){
    const d = Math.abs(MAP[k].y - y);
    if(d < bestD){ bestD=d; best=k; }
  }
  return best;
}

function clearLevelUI(){
  placedG.innerHTML = "";
  bandG.innerHTML = "";
  levelStage.querySelectorAll(".marker").forEach(m => m.remove());
  pool.innerHTML = "";
  btnChild.classList.remove("ok");
}

function setLockedState(locked){
  btnListen.disabled = locked;
  btnChild.disabled  = locked;
  btnNegra.disabled  = locked;
  btnBlanca.disabled = locked;
}

function isComplete(){
  return placed.length === target.length && placed.join("|") === target.join("|");
}

function onComplete(){
  btnNext.disabled = false;
  setLockedState(true);
  btnChild.classList.add("ok");
}

function addPlacedNote(sol, slotIdx){
  placedG.insertAdjacentHTML("beforeend",
    noteSVG(SLOT_X[slotIdx], MAP[sol].y, MAP[sol].ledgerLines)
  );

  const m = document.createElement("div");
  m.className = "marker";
  m.style.left = (SLOT_X[slotIdx] / 760 * levelStage.clientWidth) + "px";
  m.style.top  = (MAP[sol].y / 280 * levelStage.clientHeight) + "px";
  levelStage.appendChild(m);
}

function renderCurrentToken(){
  pool.innerHTML = "";
  if(tokenIdx >= target.length) return;

  const n = target[tokenIdx];

  const t = document.createElement("div");
  t.className = "token";
  t.dataset.note = n;

  t.innerHTML = `
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M14 3v10.4a3.6 3.6 0 1 1-2-3.2V5.2l8-2.2V13a3.6 3.6 0 1 1-2-3.2V3z" fill="#fff"/>
    </svg>
    <div style="font-weight:900;font-size:16px;letter-spacing:.3px">${n}</div>
  `;

  t.addEventListener("click", () => playNote(n, speakerLvl, false).catch(console.error));

  t.addEventListener("pointerdown", (e) => {
    e.preventDefault();
    getAudioContext();

    const startRect = t.getBoundingClientRect();
    const ghost = t.cloneNode(true);
    ghost.style.position = "fixed";
    ghost.style.left = startRect.left + "px";
    ghost.style.top = startRect.top + "px";
    ghost.style.opacity = "0.75";
    ghost.style.zIndex = "9999";
    ghost.style.pointerEvents = "none";
    document.body.appendChild(ghost);

    let hoverSol = null;

    const move = (ev) => {
      ghost.style.left = (ev.clientX - startRect.width/2) + "px";
      ghost.style.top  = (ev.clientY - startRect.height/2) + "px";

      const r = levelStage.getBoundingClientRect();
      const inside = (ev.clientX >= r.left && ev.clientX <= r.right && ev.clientY >= r.top && ev.clientY <= r.bottom);
      if(!inside){
        showBand(null);
        hoverSol = null;
        return;
      }

      const relY = (ev.clientY - r.top) / r.height * 280;
      hoverSol = nearestSolByY(relY);
      showBand(hoverSol);
    };

    const up = (ev) => {
      document.removeEventListener("pointermove", move);
      document.removeEventListener("pointerup", up);
      ghost.remove();
      showBand(null);

      const r = levelStage.getBoundingClientRect();
      const inside = (ev.clientX >= r.left && ev.clientX <= r.right && ev.clientY >= r.top && ev.clientY <= r.bottom);
      if(!inside) return;

      const slotIdx = tokenIdx;
      const relY = (ev.clientY - r.top) / r.height * 280;
      const best = nearestSolByY(relY);

      const expected = target[slotIdx];
      if(best === expected){
        showBand(best, true);

        placed[slotIdx] = best;
        addPlacedNote(best, slotIdx);

        playNote(best, speakerLvl, false).catch(console.error);

        tokenIdx++;
        renderCurrentToken();

        if(isComplete()){
          onComplete();
        }
      }
    };

    document.addEventListener("pointermove", move, { passive:false });
    document.addEventListener("pointerup", up, { passive:false });
  });

  pool.appendChild(t);
}

function startLevel(i){
  stopPlayback();

  levelIndex = i;
  target = LEVELS[levelIndex];
  placed = Array(target.length).fill(null);
  tokenIdx = 0;

  lvlTitle.textContent = `Nivel ${levelIndex + 1}`;
  btnNext.disabled = true;
  setLockedState(false);

  clearLevelUI();
  renderCurrentToken();
}

btnListen.addEventListener("click", () => {
  if(btnListen.disabled) return;
  playSequence(target, speakerLvl, false).catch(console.error);
});
btnChild.addEventListener("click", () => {
  if(btnChild.disabled) return;
  const current = placed.filter(Boolean);
  playSequence(current, speakerLvl, false).catch(console.error);
});
btnNext.addEventListener("click", () => {
  if(btnNext.disabled) return;
  const next = levelIndex + 1;
  if(next < LEVELS.length) startLevel(next);
  else startLevel(0);
});

document.getElementById("lvlSvg").addEventListener("pointerdown", (e) => {
  if(!placed.some(Boolean)) return;

  const svg = document.getElementById("lvlSvg");
  const pt = svg.createSVGPoint();
  pt.x = e.clientX; pt.y = e.clientY;
  const ctm = svg.getScreenCTM();
  if(!ctm) return;
  const loc = pt.matrixTransform(ctm.inverse());

  let bestSlot = -1;
  let bestDx = Infinity;
  for(let i=0;i<SLOT_X.length;i++){
    const dx = Math.abs(SLOT_X[i] - loc.x);
    if(dx < bestDx){ bestDx = dx; bestSlot = i; }
  }
  if(bestSlot === -1 || bestDx > 40) return;

  const sol = placed[bestSlot];
  if(!sol) return;

  playNote(sol, speakerLvl, false).catch(console.error);
});

startLevel(0);
</script>
</body>
</html>
