<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Escala y ejercicios (arrastrar notas)</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#111a33;
      --panel2:#0f1730;
      --ink:#e9ecff;
      --muted:#aab2ff;
      --ok:#29d37a;
      --bad:#ff4d6d;
      --line:rgba(255,255,255,.18);
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:16px;
      --gap:14px;
      --font: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--font);
      background: radial-gradient(1200px 700px at 30% 10%, #1a2550 0%, var(--bg) 55%, #050812 100%);
      color:var(--ink);
    }
    header{
      padding:14px 18px;
      border-bottom:1px solid var(--line);
      background: rgba(15,23,48,.55);
      backdrop-filter: blur(8px);
      position: sticky;
      top:0;
      z-index: 10;
    }
    header .title{
      display:flex;
      gap:12px;
      align-items:baseline;
      flex-wrap:wrap;
    }
    header h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
    }
    header .hint{
      margin:0;
      color:var(--muted);
      font-size:13px;
    }

    .wrap{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gap);
      padding: 14px;
      height: calc(100vh - 56px);
    }

    .panel{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height: 0;
    }
    .panel .head{
      padding: 12px 14px;
      border-bottom: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .panel .head .label{
      font-weight:700;
      font-size:14px;
      letter-spacing:.2px;
    }
    .panel .head .sub{
      color: var(--muted);
      font-size:12px;
      font-weight:500;
    }
    .content{
      padding: 12px 14px;
      overflow:auto;
      min-height:0;
    }

    /* Cards */
    .card{
      background: rgba(7,12,28,.35);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 12px;
    }
    .row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom: 8px;
    }
    .row .small{
      color:var(--muted);
      font-size:12px;
    }
    .btn{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: var(--ink);
      padding: 7px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:700;
      font-size:12px;
    }
    .btn:active{ transform: translateY(1px); }

    /* Staff */
    .staff{
      width: 100%;
      max-width: 540px;
      margin: 0 auto;
      display:block;
    }
    .legend{
      margin-top: 8px;
      color: var(--muted);
      font-size: 12px;
      text-align:center;
    }

    /* Notes */
    .note{
      width: 44px;
      height: 44px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:grab;
      user-select:none;
      touch-action:none;
      font-weight:900;
      letter-spacing:.2px;
      position: relative;
    }
    .note::before{
      content:"‚ô™";
      font-size:20px;
      opacity:.9;
    }
    .note[data-pitch]::after{
      content: attr(data-pitch);
      position:absolute;
      bottom:-16px;
      font-size:10px;
      color: rgba(255,255,255,.55);
      font-weight:700;
    }
    .pool{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      align-items:flex-start;
      padding-top: 10px;
      border-top: 1px dashed rgba(255,255,255,.14);
      margin-top: 10px;
    }

    /* Drop zones */
    .dropzone{
      width: 58px;
      height: 58px;
      border-radius: 14px;
      border: 2px dashed rgba(255,255,255,.22);
      background: rgba(255,255,255,.03);
      position:absolute;
      left: calc(var(--x) * 1px);
      top: calc(var(--y) * 1px);
      display:flex;
      align-items:center;
      justify-content:center;
      transition: .12s ease;
    }
    .dropzone.dragover{
      border-color: rgba(41, 211, 122, .75);
      background: rgba(41,211,122,.10);
      transform: scale(1.03);
    }
    .dropzone.ok{
      border-style: solid;
      border-color: rgba(41, 211, 122, .85);
      background: rgba(41, 211, 122, .14);
    }
    .dropzone.bad{
      border-color: rgba(255,77,109,.85);
      background: rgba(255,77,109,.12);
      animation: shake .18s linear 0s 2;
    }
    @keyframes shake{
      0%{ transform: translateX(0); }
      25%{ transform: translateX(-3px); }
      50%{ transform: translateX(3px); }
      75%{ transform: translateX(-2px); }
      100%{ transform: translateX(0); }
    }

    .exerciseStage{
      position:relative;
      width: 100%;
      max-width: 540px;
      margin: 0 auto;
      border-radius: 14px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.02);
    }

    /* Responsive */
    @media (max-width: 980px){
      .wrap{ grid-template-columns: 1fr; height: auto; }
      .panel{ min-height: 340px; }
    }
  </style>
</head>
<body>
<header>
  <div class="title">
    <h1>Do‚ÄìRe‚ÄìMi (arrastrar notas)</h1>
    <p class="hint">Derecha: clicas la escala y suena. Izquierda: arrastra las 3 notas correctas a sus huecos.</p>
  </div>
</header>

<div class="wrap">
  <!-- LEFT: Exercises -->
  <section class="panel" aria-label="Ejercicios">
    <div class="head">
      <div>
        <div class="label">Ejercicios (scroll)</div>
        <div class="sub">Cada tarjeta: 3 notas</div>
      </div>
      <button class="btn" id="resetAll">Reiniciar todo</button>
    </div>
    <div class="content" id="exercises"></div>
  </section>

  <!-- RIGHT: Scale -->
  <section class="panel" aria-label="Escala">
    <div class="head">
      <div>
        <div class="label">Escala de referencia</div>
        <div class="sub">Clica una nota para escucharla</div>
      </div>
      <button class="btn" id="unlockAudio">Activar sonido</button>
    </div>
    <div class="content">
      <svg class="staff" id="scaleSvg" viewBox="0 0 620 240" role="img" aria-label="Pentagrama con escala">
        <!-- Staff lines -->
        <g stroke="rgba(255,255,255,.22)" stroke-width="2">
          <line x1="40" y1="60" x2="580" y2="60" />
          <line x1="40" y1="85" x2="580" y2="85" />
          <line x1="40" y1="110" x2="580" y2="110" />
          <line x1="40" y1="135" x2="580" y2="135" />
          <line x1="40" y1="160" x2="580" y2="160" />
        </g>

        <!-- Treble-ish mark (simple) -->
        <text x="50" y="130" font-size="52" fill="rgba(255,255,255,.55)" font-weight="700">ùÑû</text>

        <!-- Notes will be injected here -->
        <g id="scaleNotes"></g>

        <!-- Labels -->
        <g id="scaleLabels" fill="rgba(255,255,255,.55)" font-size="14" font-weight="800"></g>
      </svg>
      <div class="legend">Rango usado: C4 (do) ‚Üí C5 (do). (Sin sostenidos/bemoles)</div>
    </div>
  </section>
</div>

<script>
  // ====== AUDIO (WebAudio) ======
  let audioCtx = null;

  function ensureAudio() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === "suspended") audioCtx.resume();
  }

  function playTone(freq, ms=340) {
    try{
      ensureAudio();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = "sine";
      o.frequency.value = freq;
      g.gain.value = 0.0001;
      o.connect(g);
      g.connect(audioCtx.destination);

      const now = audioCtx.currentTime;
      g.gain.exponentialRampToValueAtTime(0.35, now + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, now + ms/1000);

      o.start(now);
      o.stop(now + ms/1000 + 0.02);
    }catch(e){
      console.warn("Audio error", e);
    }
  }

  // ====== NOTES / POSITIONS ======
  // We use diatonic scale only: C D E F G A B C (C4..C5)
  const scale = [
    {name:"do", pitch:"C4", freq:261.63, y:160},
    {name:"re", pitch:"D4", freq:293.66, y:147.5},
    {name:"mi", pitch:"E4", freq:329.63, y:135},
    {name:"fa", pitch:"F4", freq:349.23, y:122.5},
    {name:"sol", pitch:"G4", freq:392.00, y:110},
    {name:"la", pitch:"A4", freq:440.00, y:97.5},
    {name:"si", pitch:"B4", freq:493.88, y:85},
    {name:"do", pitch:"C5", freq:523.25, y:72.5},
  ];

  const pitchToFreq = Object.fromEntries(scale.map(n => [n.pitch, n.freq]));
  const pitchToY = Object.fromEntries(scale.map(n => [n.pitch, n.y]));

  // Draw a simple "note head + stem" in SVG
  function svgNote(x, y, pitch, clickable=false) {
    const g = document.createElementNS("http://www.w3.org/2000/svg","g");
    g.setAttribute("transform", `translate(${x},${y})`);
    if (clickable) {
      g.style.cursor = "pointer";
      g.addEventListener("click", () => playTone(pitchToFreq[pitch]));
    }
    // Head
    const head = document.createElementNS("http://www.w3.org/2000/svg","ellipse");
    head.setAttribute("cx","0"); head.setAttribute("cy","0");
    head.setAttribute("rx","12"); head.setAttribute("ry","9");
    head.setAttribute("fill","rgba(255,255,255,.92)");
    head.setAttribute("transform","rotate(-18)");
    // Stem
    const stem = document.createElementNS("http://www.w3.org/2000/svg","line");
    stem.setAttribute("x1","10"); stem.setAttribute("y1","-2");
    stem.setAttribute("x2","10"); stem.setAttribute("y2","-48");
    stem.setAttribute("stroke","rgba(255,255,255,.92)");
    stem.setAttribute("stroke-width","3");
    stem.setAttribute("stroke-linecap","round");

    // Small hover glow
    g.addEventListener("mouseenter", () => head.setAttribute("fill","white"));
    g.addEventListener("mouseleave", () => head.setAttribute("fill","rgba(255,255,255,.92)"));

    g.appendChild(head);
    g.appendChild(stem);
    return g;
  }

  // ====== RIGHT PANEL: scale ======
  (function renderScale(){
    const notesG = document.getElementById("scaleNotes");
    const labelsG = document.getElementById("scaleLabels");
    const startX = 160;
    const stepX = 55;

    scale.forEach((n, i) => {
      const x = startX + stepX * i;
      const y = n.y;
      notesG.appendChild(svgNote(x, y, n.pitch, true));

      const t = document.createElementNS("http://www.w3.org/2000/svg","text");
      t.setAttribute("x", x - 10);
      t.setAttribute("y", 205);
      t.textContent = n.name;
      labelsG.appendChild(t);
    });
  })();

  document.getElementById("unlockAudio").addEventListener("click", () => {
    ensureAudio();
    // tiny click sound feedback
    playTone(440, 120);
  });

  // ====== LEFT PANEL: exercises ======
  const EXERCISES = [
    { id:"E1", title:"Ejercicio 1", notes:["C4","E4","G4"] }, // do mi sol
    { id:"E2", title:"Ejercicio 2", notes:["D4","F4","E4"] }, // re fa mi
    { id:"E3", title:"Ejercicio 3", notes:["A4","B4","C5"] }, // la si do
  ];

  function shuffle(arr){
    return arr.map(v => [Math.random(), v]).sort((a,b)=>a[0]-b[0]).map(x=>x[1]);
  }

  function makeExerciseCard(ex){
    const card = document.createElement("div");
    card.className = "card";
    card.dataset.exercise = ex.id;

    const row = document.createElement("div");
    row.className = "row";
    row.innerHTML = `
      <div>
        <div style="font-weight:900">${ex.title}</div>
        <div class="small">Coloca estas 3 notas en su sitio (de izquierda a derecha).</div>
      </div>
      <button class="btn">Reiniciar</button>
    `;

    const resetBtn = row.querySelector("button");
    resetBtn.addEventListener("click", () => resetExercise(card, ex));

    // Stage (staff + dropzones)
    const stage = document.createElement("div");
    stage.className = "exerciseStage";

    // SVG staff
    const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
    svg.setAttribute("class","staff");
    svg.setAttribute("viewBox","0 0 620 240");
    svg.innerHTML = `
      <g stroke="rgba(255,255,255,.22)" stroke-width="2">
        <line x1="40" y1="60" x2="580" y2="60" />
        <line x1="40" y1="85" x2="580" y2="85" />
        <line x1="40" y1="110" x2="580" y2="110" />
        <line x1="40" y1="135" x2="580" y2="135" />
        <line x1="40" y1="160" x2="580" y2="160" />
      </g>
      <text x="50" y="130" font-size="52" fill="rgba(255,255,255,.55)" font-weight="700">ùÑû</text>
      <g class="placed"></g>
      <g fill="rgba(255,255,255,.55)" font-size="12" font-weight="900">
        <text x="40" y="30">Arrastra las notas al pentagrama</text>
      </g>
    `;
    stage.appendChild(svg);

    // Dropzones (3 positions)
    // We'll place them at fixed x positions; y is centered around target note y
    // We'll use absolute px positions relative to stage, so compute from viewBox to element later.
    // Simpler: use a fixed mapping approximated for the stage's current rendered size.
    // We'll convert "viewBox coords" -> "px" each time (on resize too).
    const dzWrap = document.createElement("div");
    dzWrap.style.position = "absolute";
    dzWrap.style.left = "0";
    dzWrap.style.top = "0";
    dzWrap.style.right = "0";
    dzWrap.style.bottom = "0";
    stage.appendChild(dzWrap);

    // Create 3 dropzones
    const xs = [250, 340, 430]; // viewBox x coords for 3 slots
    ex.notes.forEach((pitch, idx) => {
      const dz = document.createElement("div");
      dz.className = "dropzone";
      dz.dataset.accept = pitch;         // correct pitch for this slot
      dz.dataset.slot = String(idx);
      dz.dataset.vbx = String(xs[idx]);  // viewBox x center
      dz.dataset.vby = String(pitchToY[pitch]); // viewBox y center
      dzWrap.appendChild(dz);

      // Drag events
      dz.addEventListener("dragover", (e) => {
        e.preventDefault();
        if (dz.classList.contains("ok")) return;
        dz.classList.add("dragover");
      });
      dz.addEventListener("dragleave", () => dz.classList.remove("dragover"));
      dz.addEventListener("drop", (e) => {
        e.preventDefault();
        dz.classList.remove("dragover");
        if (dz.classList.contains("ok")) return;

        const noteId = e.dataTransfer.getData("text/plain");
        const noteEl = card.querySelector(`.note[data-note-id="${noteId}"]`);
        if (!noteEl) return;

        const pitchDragged = noteEl.dataset.pitch;
        const accept = dz.dataset.accept;

        if (pitchDragged === accept) {
          dz.classList.remove("bad");
          dz.classList.add("ok");

          // Place SVG note on staff at the correct position (slot x, pitch y)
          const placedG = svg.querySelector(".placed");
          const x = Number(dz.dataset.vbx);
          const y = Number(dz.dataset.vby);
          placedG.appendChild(svgNote(x, y, pitchDragged, false));

          // Disable dragged note
          noteEl.draggable = false;
          noteEl.style.opacity = "0.35";
          noteEl.style.cursor = "default";

          playTone(pitchToFreq[pitchDragged], 260);

          // If all 3 are ok -> success chord-ish
          const allOk = Array.from(card.querySelectorAll(".dropzone")).every(z => z.classList.contains("ok"));
          if (allOk) {
            setTimeout(() => playTone(523.25, 160), 50);
            setTimeout(() => playTone(659.25, 160), 220);
          }
        } else {
          dz.classList.remove("ok");
          dz.classList.add("bad");
          playTone(196.00, 120);
          setTimeout(() => dz.classList.remove("bad"), 250);
        }
      });
    });

    // Pool of draggable notes (shuffled)
    const pool = document.createElement("div");
    pool.className = "pool";

    const poolPitches = shuffle(ex.notes.slice());
    poolPitches.forEach((pitch, i) => {
      const n = document.createElement("div");
      n.className = "note";
      n.draggable = true;
      n.dataset.pitch = pitch;
      n.dataset.noteId = `${ex.id}_${i}_${pitch}`;
      n.addEventListener("dragstart", (e) => {
        ensureAudio(); // unlock by gesture
        e.dataTransfer.setData("text/plain", n.dataset.noteId);
        e.dataTransfer.effectAllowed = "move";
      });
      n.addEventListener("click", () => playTone(pitchToFreq[pitch], 260));
      pool.appendChild(n);
    });

    // Layout fix: place dropzones based on stage size
    function positionDropzones(){
      const rect = stage.getBoundingClientRect();
      // viewBox is 620 x 240
      const scaleX = rect.width / 620;
      const scaleY = rect.height / 240;

      dzWrap.querySelectorAll(".dropzone").forEach(dz => {
        const vbx = Number(dz.dataset.vbx);
        const vby = Number(dz.dataset.vby);
        // center the zone on the point
        const px = vbx * scaleX - 29; // half of 58
        const py = vby * scaleY - 29;
        dz.style.setProperty("--x", px.toFixed(2));
        dz.style.setProperty("--y", py.toFixed(2));
      });
    }

    // Observe resizing (simple)
    const ro = new ResizeObserver(positionDropzones);
    ro.observe(stage);
    window.addEventListener("resize", positionDropzones);
    setTimeout(positionDropzones, 0);

    card.appendChild(row);
    card.appendChild(stage);
    card.appendChild(pool);
    return card;
  }

  function resetExercise(card, ex){
    // Reset dropzones
    card.querySelectorAll(".dropzone").forEach(dz => {
      dz.classList.remove("ok","bad","dragover");
    });
    // Clear placed notes
    const svg = card.querySelector("svg");
    const placed = svg.querySelector(".placed");
    placed.innerHTML = "";

    // Re-enable pool notes + reshuffle order
    const pool = card.querySelector(".pool");
    const notes = Array.from(pool.querySelectorAll(".note"));
    notes.forEach(n => {
      n.draggable = true;
      n.style.opacity = "1";
      n.style.cursor = "grab";
    });

    // Shuffle DOM
    const shuffled = shuffle(notes);
    pool.innerHTML = "";
    shuffled.forEach(n => pool.appendChild(n));

    playTone(261.63, 120);
  }

  function renderExercises(){
    const root = document.getElementById("exercises");
    root.innerHTML = "";
    EXERCISES.forEach(ex => root.appendChild(makeExerciseCard(ex)));
  }

  document.getElementById("resetAll").addEventListener("click", () => {
    renderExercises();
    playTone(329.63, 120);
  });

  renderExercises();
</script>
</body>
</html>
