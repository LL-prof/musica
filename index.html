<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Lectura Musical Infantil</title>

<style>
:root{
  --bg:#10131a;
  --sheet:#ffffff;
  --shadow:0 14px 36px rgba(0,0,0,.35);
  --radius:18px;
  --ok:#25c26e;
  --yellow:rgba(180,140,0,.35);
}

*{box-sizing:border-box}

body{
  margin:0;
  background:radial-gradient(1200px 700px at 30% 10%, #20283a 0%, var(--bg) 60%, #070a11 100%);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  height:100vh;
}

.wrap{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:14px;
  padding:14px;
  height:100vh;
}

.panel{
  background:rgba(255,255,255,.05);
  border-radius:18px;
  box-shadow:var(--shadow);
  overflow:auto;
}

.sheet{
  background:#fff;
  border-radius:16px;
  padding:12px;
  margin-bottom:14px;
}

.stage{ position:relative }

svg{ width:100%; height:auto; display:block }

/* BOTONES */
.durRow{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
  margin-bottom:10px;
}
.durBtn{
  height:64px;
  border-radius:16px;
  border:2px solid #aaa;
  background:#fff;
  font-weight:900;
  cursor:pointer;
}
.durBtn.active{
  box-shadow:0 0 0 4px rgba(37,194,110,.25);
}

.playRow{
  display:flex;
  justify-content:center;
  gap:12px;
  margin-bottom:6px;
}
.playBtn{
  width:64px;
  height:48px;
  border-radius:14px;
  border:2px solid #aaa;
  background:#fff;
  cursor:pointer;
  transition:.15s;
}
.playBtn:hover{ background:#eaeaea }
.playBtn:active{ background:#d5d5d5 }
.playBtn.ok{ box-shadow:0 0 0 4px rgba(37,194,110,.3) }

/* POOL */
.pool{
  display:flex;
  justify-content:center;
  gap:12px;
  margin-top:8px;
}
.token{
  width:72px;
  height:84px;
  background:#111;
  color:#fff;
  border-radius:18px;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:4px;
  cursor:grab;
}
.token.locked{ opacity:.3; cursor:default }

.name{ font-weight:900; font-size:14px }

/* MARCADOR VERDE */
.marker{
  position:absolute;
  width:40px;
  height:40px;
  border-radius:12px;
  background:rgba(37,194,110,.25);
  border:2px solid rgba(37,194,110,.7);
  transform:translate(-50%,-50%);
}
</style>
</head>

<body>
<div class="wrap">

<!-- IZQUIERDA: REFERENCIA -->
<div class="panel">
  <div class="sheet">
    <div class="durRow">
      <button class="durBtn active" id="negra">NEGRA</button>
      <button class="durBtn" id="blanca">BLANCA</button>
    </div>

    <svg viewBox="0 0 760 280" id="refSvg">
      <g stroke="#000" stroke-width="2">
        <line x1="40" y1="80" x2="720" y2="80"/>
        <line x1="40" y1="105" x2="720" y2="105"/>
        <line x1="40" y1="130" x2="720" y2="130"/>
        <line x1="40" y1="155" x2="720" y2="155"/>
        <line x1="40" y1="180" x2="720" y2="180"/>
      </g>
      <text x="54" y="155" font-size="56">ùÑû</text>
      <g id="refNotes"></g>
      <g id="refNames"></g>
    </svg>
  </div>
</div>

<!-- DERECHA: EJERCICIOS -->
<div class="panel" id="exercises"></div>

</div>

<script>
// ================= AUDIO =================
let ctx;
function audio(){ if(!ctx) ctx=new AudioContext(); if(ctx.state==="suspended") ctx.resume(); }
function tone(f,d){
  audio();
  const o=ctx.createOscillator(), g=ctx.createGain();
  o.frequency.value=f; o.type="sine";
  g.gain.setValueAtTime(.0001,ctx.currentTime);
  g.gain.exponentialRampToValueAtTime(.35,ctx.currentTime+.03);
  g.gain.exponentialRampToValueAtTime(.0001,ctx.currentTime+d/1000);
  o.connect(g); g.connect(ctx.destination);
  o.start(); o.stop(ctx.currentTime+d/1000+.05);
}
const NEGRA=800, BLANCA=2600;
let dur=NEGRA;

// silencio inicial + reproducci√≥n r√°pida
async function playSeq(freqs){
  await new Promise(r=>setTimeout(r,500));
  for(const f of freqs){
    tone(f,dur);
    await new Promise(r=>setTimeout(r,dur+90));
  }
}

// ================= DATOS =================
const MAP={
  do:[261.63,205],
  re:[293.66,192.5],
  mi:[329.63,180],
  fa:[349.23,167.5],
  sol:[392,155],
  la:[440,142.5],
  si:[493.88,130],
  do5:[523.25,117.5]
};
const SCALE=["do","re","mi","fa","sol","la","si","do5"];

// ================= NOTA SVG =================
function noteSVG(x,y,ledger=false){
  return `
  <g transform="translate(${x},${y})">
    ${ledger?`<line x1="-22" y1="0" x2="22" y2="0" stroke="#000" stroke-width="2"/>`:``}
    <ellipse rx="12" ry="9" fill="#000" transform="rotate(-18)"/>
    <line x1="10" y1="-2" x2="10" y2="-50" stroke="#000" stroke-width="3"/>
  </g>`;
}

// ================= REFERENCIA =================
const refN=document.getElementById("refNotes");
const refL=document.getElementById("refNames");
SCALE.forEach((s,i)=>{
  const x=190+i*70;
  const y=MAP[s][1];
  refN.insertAdjacentHTML("beforeend",noteSVG(x,y,s==="do"));
  refL.insertAdjacentHTML("beforeend",
    `<text x="${x-14}" y="265" font-size="16">${s==="do5"?"do":s}</text>`);
});

// ================= BOTONES DURACI√ìN =================
negra.onclick=()=>{dur=NEGRA; negra.classList.add("active"); blanca.classList.remove("active")};
blanca.onclick=()=>{dur=BLANCA; blanca.classList.add("active"); negra.classList.remove("active")};

// ================= EJERCICIOS =================
const DATA=[
 ["do","do","do"],
 ["mi","mi","mi"],
 ["re","re","re"],
 ["do","re","mi"]
];

const exDiv=document.getElementById("exercises");

DATA.forEach(target=>{
  const sheet=document.createElement("div");
  sheet.className="sheet";

  const playRow=document.createElement("div");
  playRow.className="playRow";

  const p1=document.createElement("button");
  p1.className="playBtn";
  p1.innerHTML="‚ñ∂";
  const p2=document.createElement("button");
  p2.className="playBtn";
  p2.innerHTML="‚ñ∂";

  playRow.append(p1,p2);
  sheet.append(playRow);

  p1.onclick=()=>playSeq(target.map(n=>MAP[n][0]));
  p2.onclick=()=>playSeq(placed.map(n=>MAP[n][0]));

  const stage=document.createElement("div");
  stage.className="stage";
  stage.innerHTML=document.getElementById("refSvg").outerHTML;
  const svg=stage.querySelector("svg");
  svg.querySelector("#refNotes")?.remove();
  svg.querySelector("#refNames")?.remove();
  const placedG=document.createElementNS("http://www.w3.org/2000/svg","g");
  svg.append(placedG);
  sheet.append(stage);

  const pool=document.createElement("div");
  pool.className="pool";
  sheet.append(pool);

  let placed=[null,null,null];

  target.forEach(n=>{
    const t=document.createElement("div");
    t.className="token";
    t.innerHTML=`‚ô™<div class="name">${n==="do5"?"do":n}</div>`;
    t.onclick=()=>tone(MAP[n][0],dur);
    pool.append(t);
  });

  exDiv.append(sheet);
});
</script>
</body>
</html>
