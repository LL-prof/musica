<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Lectura musical</title>

<style>
:root{
  --bg:#10131a;
  --shadow:0 14px 36px rgba(0,0,0,.35);
  --yellow:rgba(180,140,0,.35);
  --ok:#25c26e;
  --card:rgba(255,255,255,.06);
}

*{box-sizing:border-box}
body{
  margin:0;
  background:radial-gradient(1200px 700px at 30% 10%, #20283a 0%, var(--bg) 60%, #070a11 100%);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  min-height:100vh;
}
.wrap{
  width:min(980px, 100%);
  margin:0 auto;
  padding:14px;
  display:grid;
  gap:14px;
}
.panel{
  background:var(--card);
  border-radius:18px;
  box-shadow:var(--shadow);
  overflow:hidden;
}
.rowTop{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding:14px;
}
.title{
  color:#fff;
  font-weight:900;
  margin:0;
  font-size:18px;
  letter-spacing:.3px;
  user-select:none;
}

/* CONTROLES (entre pentagramas) */
.controlsBar{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:12px;
  flex-wrap:wrap;
  padding:12px 14px 14px;
}
.controls{
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:center;
  flex-wrap:wrap;
}
.ctrlBtn{
  width:56px;height:46px;border-radius:14px;
  border:2px solid rgba(255,255,255,.35);
  background:rgba(255,255,255,.06);
  color:#fff;
  cursor:pointer;
  font-weight:900;
  transition:.12s;
}
.ctrlBtn:hover{ background:rgba(255,255,255,.10); }
.ctrlBtn:active{ transform:scale(.98); }
.ctrlBtn[disabled]{ opacity:.28; cursor:not-allowed; }

.modeBtn{
  width:72px;
  background:#fff;
  color:#111;
  border-color:#bbb;
}
.modeBtn.active{
  box-shadow:0 0 0 4px rgba(37,194,110,.20);
  border-color:rgba(37,194,110,.6);
}

/* Play del alumno: rojo -> verde cuando 4/4 */
.childBtn{
  border-color:#c0392b;
  background:#ffecec;
  color:#111;
}
.childBtn:hover{ background:#ffdede; }
.childBtn.ok{
  border-color: var(--ok);
  background:#eafff1;
}
.childBtn.ok:hover{ background:#dbffea; }

/* puntos acumulados */
.scoreBox{
  display:flex;
  align-items:baseline;
  gap:8px;
  padding:8px 12px;
  border-radius:14px;
  border:2px solid rgba(255,255,255,.20);
  background:rgba(0,0,0,.22);
  color:#fff;
  user-select:none;
}
.scoreBox .num{
  font-weight:950;
  font-size:20px;
  letter-spacing:.3px;
}
.scoreBox .lbl{
  opacity:.85;
  font-weight:800;
  font-size:12px;
  letter-spacing:.3px;
}
.scoreBox .mul{
  margin-left:6px;
  padding:2px 8px;
  border-radius:999px;
  background:rgba(37,194,110,.18);
  border:1px solid rgba(37,194,110,.45);
  font-weight:900;
  font-size:12px;
}
.toast{
  position:relative;
  height:0;
  width:100%;
}
.toast .pop{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  top:-6px;
  padding:6px 10px;
  border-radius:12px;
  background:rgba(255,255,255,.92);
  color:#111;
  font-weight:900;
  font-size:13px;
  box-shadow:var(--shadow);
  opacity:0;
  pointer-events:none;
  transition:opacity .18s ease, transform .18s ease;
}
.toast .pop.show{
  opacity:1;
  transform:translateX(-50%) translateY(-8px);
}

.sheet{
  background:#fff;
  border-radius:16px;
  padding:12px;
  margin:14px;
}
.stage{ position:relative; }
svg{ width:100%; height:auto; display:block; }

/* ref m√°s peque√±o */
.refWrap{
  width:60%;
  margin:0 auto;
}

.pool{
  display:flex;
  justify-content:center;
  gap:18px;
  margin:10px 14px 18px;
  flex-wrap:wrap;
  min-height:96px;
}

/* ‚úÖ tokens: nota flotante (sin ‚Äúbot√≥n‚Äù) */
.token{
  width:92px;
  height:96px;
  border-radius:16px;
  background:transparent;
  color:#111;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:6px;
  cursor:grab;
  user-select:none;
  touch-action:none;
}
.token svg{ width:42px; height:42px; display:block; filter:drop-shadow(0 8px 10px rgba(0,0,0,.18)); }
.token .lbl{ font-weight:950; font-size:13px; letter-spacing:.2px; opacity:.95; }

.marker{
  position:absolute;
  width:38px;height:38px;border-radius:12px;
  background:rgba(37,194,110,.25);
  border:2px solid rgba(37,194,110,.7);
  transform:translate(-50%,-50%);
  pointer-events:none;
}

/* banda amarilla "flash" al acertar */
.bandFlash{
  animation: bandFlash .22s ease-in-out 0s 2;
}
@keyframes bandFlash{
  0%   { opacity:1; transform:scaleX(1); }
  50%  { opacity:.25; transform:scaleX(.98); }
  100% { opacity:1; transform:scaleX(1); }
}
.hintBar{
  height:8px;
  width:100%;
  background:rgba(255,255,255,.08);
}

/* ‚úÖ playhead: aparece encima de cada nota (por pasos) */
.playhead{
  position:absolute;
  top:16px;
  bottom:16px;
  width:4px;
  border-radius:999px;
  background:rgba(255,60,60,.95);
  box-shadow:0 10px 18px rgba(0,0,0,.25);
  pointer-events:none;
  opacity:0;
  transform:translateX(-2px);
}
.playhead.show{ opacity:1; }
</style>
</head>

<body>
  <div class="wrap">
    <div class="panel">

      <div class="rowTop">
        <p class="title" id="lvlTitle">Nivel 1</p>
      </div>
      <div class="hintBar"></div>

      <!-- ARRIBA: REFERENCIA -->
      <div class="sheet">
        <div class="stage refWrap" id="refStage">
          <svg viewBox="0 0 760 260" id="refSvg" aria-label="Escala de referencia">
            <g stroke="#000" stroke-width="2">
              <line x1="40" y1="60"  x2="720" y2="60"/>
              <line x1="40" y1="85"  x2="720" y2="85"/>
              <line x1="40" y1="110" x2="720" y2="110"/>
              <line x1="40" y1="135" x2="720" y2="135"/>
              <line x1="40" y1="160" x2="720" y2="160"/>
            </g>
            <text x="54" y="135" font-size="56">ùÑû</text>

            <g id="refNotes"></g>
            <g id="refNames"></g>
          </svg>
        </div>
      </div>

      <!-- CONTROLES ENTRE PENTAGRAMAS -->
      <div class="controlsBar" aria-label="Controles">
        <div class="scoreBox" aria-label="Puntos">
          <span class="num" id="score">0</span>
          <span class="lbl">pts</span>
          <span class="mul" id="mul">x1</span>
        </div>

        <div class="controls">
          <button class="ctrlBtn modeBtn active" id="btnNegra" aria-label="Referencia negra">N</button>
          <button class="ctrlBtn modeBtn" id="btnBlanca" aria-label="Referencia blanca">B</button>

          <button class="ctrlBtn" id="btnListen" aria-label="Escuchar objetivo">‚ñ∂</button>
          <button class="ctrlBtn childBtn" id="btnChild" aria-label="Escuchar lo que llevo">‚ñ∂</button>
          <button class="ctrlBtn" id="btnNext" aria-label="Siguiente" disabled>‚Üí</button>
        </div>

        <div class="toast" aria-hidden="true">
          <div class="pop" id="pop">+0</div>
        </div>
      </div>

      <!-- ABAJO: EJERCICIO -->
      <div class="sheet">
        <div class="stage" id="levelStage">
          <div class="playhead" id="playhead" aria-hidden="true"></div>

          <svg viewBox="0 0 760 280" id="lvlSvg" aria-label="Pentagrama del nivel">
            <g stroke="#000" stroke-width="2">
              <line x1="40" y1="80"  x2="720" y2="80"/>
              <line x1="40" y1="105" x2="720" y2="105"/>
              <line x1="40" y1="130" x2="720" y2="130"/>
              <line x1="40" y1="155" x2="720" y2="155"/>
              <line x1="40" y1="180" x2="720" y2="180"/>
            </g>
            <text x="54" y="155" font-size="56">ùÑû</text>

            <g id="bandG"></g>
            <g id="placedG"></g>
          </svg>
        </div>

        <div class="pool" id="pool" aria-label="Fichas"></div>
      </div>

    </div>
  </div>

<script>
/* ===================== AUDIO ===================== */
const AUDIO_FOLDER = "";
const SAMPLES = {
  do:  { white: AUDIO_FOLDER + "do_blanca.mp3",  black: AUDIO_FOLDER + "do_negra.mp3"  },
  re:  { white: AUDIO_FOLDER + "re_blanca.mp3",  black: AUDIO_FOLDER + "re_negra.mp3"  },
  mi:  { white: AUDIO_FOLDER + "mi_blanca.mp3",  black: AUDIO_FOLDER + "mi_negra.mp3"  },
  fa:  { white: AUDIO_FOLDER + "fa_blanca.mp3",  black: AUDIO_FOLDER + "fa_negra.mp3"  },
  sol: { white: AUDIO_FOLDER + "sol_blanca.mp3", black: AUDIO_FOLDER + "sol_negra.mp3" },
  la:  { white: AUDIO_FOLDER + "la_blanca.mp3",  black: AUDIO_FOLDER + "la_negra.mp3"  },
  si:  { white: AUDIO_FOLDER + "si_blanca.mp3",  black: AUDIO_FOLDER + "si_negra.mp3"  },
  do2: { white: AUDIO_FOLDER + "do_sup_negra.mp3", black: AUDIO_FOLDER + "do_sup_negra.mp3" },
};

const SCALE_EX  = ["do","re","mi","fa","sol","la","si","do2"];  // ‚úÖ do2 tambi√©n en ejercicio (ya listo)
const SCALE_REF = ["do","re","mi","fa","sol","la","si","do2"];

/* ===================== MAPEOS SEPARADOS ===================== */
const STAFF_EX  = { top: 80, bottom: 180, lineGap: 25, viewH: 280 };
const STAFF_REF = { top: 60, bottom: 160, lineGap: 25, viewH: 260 };

// offsets respecto a MI (mi=0)
const OFF_EX  = { do:+2, re:+1, mi:0, fa:-1, sol:-2, la:-3, si:-4, do2:-5 };
const OFF_REF = { do:+2, re:+1, mi:0, fa:-1, sol:-2, la:-3, si:-4, do2:-5 };

function yForEX(note){
  const step = STAFF_EX.lineGap / 2;
  return STAFF_EX.bottom + OFF_EX[note] * step;
}

// ‚úÖ ajuste fino SOLO en referencia para que el RE se vea ‚Äúclavado‚Äù
function yForREF(note){
  const step = STAFF_REF.lineGap / 2;
  let y = STAFF_REF.bottom + OFF_REF[note] * step;

  // aqu√≠ es donde lo clavamos ‚Äúa ojo‚Äù para que RE quede perfecto en el pentagrama superior
  if(note === "re") y += -5;    // prueba: si lo quieres un pel√≠n m√°s ‚Äútocando‚Äù, sube a +3
  return y;
}

function ledgerLinesRelY(noteY, staff){
  const lines = [];
  const top = staff.top, bottom = staff.bottom, gap = staff.lineGap;

  if(noteY > bottom){
    const n = Math.floor((noteY - bottom) / gap + 1e-6);
    for(let i=1;i<=n;i++){
      const yLine = bottom + i*gap;
      lines.push(yLine - noteY);
    }
  }
  if(noteY < top){
    const n = Math.floor((top - noteY) / gap + 1e-6);
    for(let i=1;i<=n;i++){
      const yLine = top - i*gap;
      lines.push(yLine - noteY);
    }
  }
  return lines;
}
function ledgerLinesSVG(relYs){
  if(!relYs.length) return "";
  return relYs.map(ry =>
    `<line x1="-22" y1="${ry}" x2="22" y2="${ry}" stroke="#000" stroke-width="2"/>`
  ).join("");
}

// ‚úÖ nota con etiqueta debajo (para ejercicio colocado)
function noteSVG(x, y, staff, label=null){
  const rels = ledgerLinesRelY(y, staff);
  const text = label ? `<text x="0" y="34" text-anchor="middle" font-size="14" font-weight="900">${label === "do2" ? "do‚Üë" : label}</text>` : "";
  return `
  <g class="placedNote" transform="translate(${x},${y})">
    ${ledgerLinesSVG(rels)}
    <ellipse rx="12" ry="9" fill="#000" transform="rotate(-18)"/>
    <line x1="10" y1="-2" x2="10" y2="-50" stroke="#000" stroke-width="3"/>
    ${text}
  </g>`;
}

const MAP_EX = Object.fromEntries(SCALE_EX.map(n => [n, { y: yForEX(n) }]));

/* ===================== AUDIO ENGINE ===================== */
let ctx = null;
let isPlaying = false;
let activeSources = [];
const bufferCache = new Map();

function getAudioContext(){
  if(!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
  if(ctx.state === "suspended") ctx.resume();
  return ctx;
}
async function loadBuffer(url){
  if(bufferCache.has(url)) return bufferCache.get(url);
  const res = await fetch(url);
  if(!res.ok) throw new Error("No se pudo cargar: " + url);
  const arr = await res.arrayBuffer();
  const ac = getAudioContext();
  const buf = await ac.decodeAudioData(arr);
  bufferCache.set(url, buf);
  return buf;
}

/* ===================== PLAYHEAD (saltos por nota, solo ejercicio) ===================== */
const levelStage = document.getElementById("levelStage");
const playhead = document.getElementById("playhead");
let playheadTimers = [];

function clearPlayheadTimers(){
  playheadTimers.forEach(t => clearTimeout(t));
  playheadTimers = [];
}
function hidePlayhead(){
  playhead.classList.remove("show");
}
function showPlayheadAtX(viewX){
  const px = (viewX / 760) * levelStage.clientWidth;
  playhead.style.left = px + "px";
  playhead.classList.add("show");
}

function schedulePlayheadSteps(slotXs, durationsSec, gapSec){
  clearPlayheadTimers();
  hidePlayhead();
  if(!slotXs.length || !durationsSec.length) return;

  const GAP = gapSec ?? 0.08;

  // empieza encima de la primera nota
  showPlayheadAtX(slotXs[0]);

  let accMs = 0;
  for(let i=0;i<durationsSec.length;i++){
    accMs += durationsSec[i] * 1000;
    if(i < slotXs.length - 1){
      playheadTimers.push(setTimeout(() => showPlayheadAtX(slotXs[i+1]), accMs));
      accMs += GAP * 1000;
    }
  }
  playheadTimers.push(setTimeout(() => hidePlayhead(), accMs + 120));
}

function stopPlayback(){
  activeSources.forEach(s => { try{ s.stop(0); }catch(e){} });
  activeSources = [];
  isPlaying = false;
  clearPlayheadTimers();
  hidePlayhead();
}

function playBufferAt(buffer, startTime, gainValue=1.0){
  const ac = getAudioContext();
  const src = ac.createBufferSource();
  const gain = ac.createGain();
  src.buffer = buffer;
  gain.gain.setValueAtTime(gainValue, startTime);
  src.connect(gain).connect(ac.destination);
  activeSources.push(src);
  src.onended = () => { activeSources = activeSources.filter(x => x !== src); };
  src.start(startTime);
  return buffer.duration;
}

/* ===================== Modo duraci√≥n (solo referencia) ===================== */
let MODE = "black";
const btnNegra = document.getElementById("btnNegra");
const btnBlanca = document.getElementById("btnBlanca");
btnNegra.addEventListener("click", () => {
  MODE = "black";
  btnNegra.classList.add("active");
  btnBlanca.classList.remove("active");
});
btnBlanca.addEventListener("click", () => {
  MODE = "white";
  btnBlanca.classList.add("active");
  btnNegra.classList.remove("active");
});

/* ===================== PUNTOS (acumulado) ===================== */
const scoreEl = document.getElementById("score");
const mulEl = document.getElementById("mul");
const pop = document.getElementById("pop");

let score = 0;
let streak = 0;
let multiplier = 1;
let mistakes = 0;

function renderScore(){
  scoreEl.textContent = String(score);
  mulEl.textContent = `x${multiplier}`;
}
function popPoints(text){
  pop.textContent = text;
  pop.classList.add("show");
  setTimeout(() => pop.classList.remove("show"), 520);
}
function onCorrectPlacement(){
  streak++;
  if(streak >= 10) multiplier = 4;
  else if(streak >= 6) multiplier = 3;
  else if(streak >= 3) multiplier = 2;
  else multiplier = 1;

  const base = 120;
  const pts = Math.round(base * multiplier);
  score += pts;
  renderScore();
  popPoints(`+${pts}`);
}
function onWrongPlacement(){
  mistakes++;
  streak = 0;
  multiplier = 1;
  const penalty = 60 + Math.min(40, mistakes * 8);
  score = Math.max(0, score - penalty);
  renderScore();
  popPoints(`-${penalty}`);
}
function onLevelCompleteBonus(){
  const speedBonus = Math.max(0, 260 - mistakes * 60);
  const streakBonus = streak >= 6 ? 180 : (streak >= 3 ? 90 : 0);
  const bonus = 240 + speedBonus + streakBonus;
  score += bonus;
  renderScore();
  popPoints(`BONUS +${bonus}`);
}

/* ===================== REFERENCIA (arriba) ===================== */
const refNotes = document.getElementById("refNotes");
const refNames = document.getElementById("refNames");

SCALE_REF.forEach((s,i)=>{
  const x = 140 + i*72;
  const y = yForREF(s);

  const g = document.createElementNS("http://www.w3.org/2000/svg","g");
  g.innerHTML = noteSVG(x, y, STAFF_REF, null); // ‚úÖ sin etiqueta encima de la referencia
  g.style.cursor = "pointer";
  g.addEventListener("pointerdown", (e) => {
    e.preventDefault();
    playNote(s, true).catch(console.error); // referencia
  });
  refNotes.appendChild(g);

  const label = (s === "do2") ? "do‚Üë" : s;
  refNames.insertAdjacentHTML("beforeend",
    `<text x="${x-16}" y="248" font-size="16" font-weight="900">${label}</text>`
  );
});

/* ===================== NIVELES ===================== */
const LEVELS = [
  ["do","re","mi","sol"],
  ["do","mi","sol","fa"],
  ["re","mi","fa","sol"],
  ["mi","re","do","sol"],
  ["sol","fa","mi","re"],
  ["do","re","fa","sol"],
  ["re","fa","sol","la"],
  ["mi","fa","sol","la"],
  ["sol","la","si","do"],
  ["la","si","do","re"],
];

const lvlTitle = document.getElementById("lvlTitle");
const btnListen = document.getElementById("btnListen");
const btnChild  = document.getElementById("btnChild");
const btnNext   = document.getElementById("btnNext");

const bandG = document.getElementById("bandG");
const placedG = document.getElementById("placedG");
const pool = document.getElementById("pool");

let levelIndex = 0;
let target = null;
let placed = [];
let tokenIdx = 0;

const SLOT_X = [300, 390, 480, 570];

/* Banda amarilla */
function showBand(sol, flash=false){
  bandG.innerHTML = "";
  if(!sol) return;

  const y = MAP_EX[sol].y;
  const rect = document.createElementNS("http://www.w3.org/2000/svg","rect");
  rect.setAttribute("x","40");
  rect.setAttribute("y", String(y - 9));
  rect.setAttribute("width","680");
  rect.setAttribute("height","18");
  rect.setAttribute("rx","6");
  rect.setAttribute("fill", getComputedStyle(document.documentElement).getPropertyValue("--yellow").trim() || "rgba(180,140,0,.35)");
  if(flash) rect.classList.add("bandFlash");
  bandG.appendChild(rect);
}
function nearestSolByY(y){
  let best=null, bestD=Infinity;
  for(const k of SCALE_EX){
    const d = Math.abs(MAP_EX[k].y - y);
    if(d < bestD){ bestD=d; best=k; }
  }
  return best;
}

function clearLevelUI(){
  placedG.innerHTML = "";
  bandG.innerHTML = "";
  levelStage.querySelectorAll(".marker").forEach(m => m.remove());
  pool.innerHTML = "";
  btnChild.classList.remove("ok");
  clearPlayheadTimers();
  hidePlayhead();
}

function setLockedState(locked){
  btnListen.disabled = locked;
  btnChild.disabled  = locked;
  btnNegra.disabled  = locked;
  btnBlanca.disabled = locked;
}

function isComplete(){
  return placed.length === target.length && placed.join("|") === target.join("|");
}

function onComplete(){
  btnNext.disabled = false;
  setLockedState(true);

  btnChild.disabled = false;
  btnChild.classList.add("ok");

  onLevelCompleteBonus();
}

function addPlacedNote(sol, slotIdx){
  const y = MAP_EX[sol].y;

  placedG.insertAdjacentHTML("beforeend",
    noteSVG(SLOT_X[slotIdx], y, STAFF_EX, sol) // ‚úÖ etiqueta debajo
  );

  const m = document.createElement("div");
  m.className = "marker";
  m.style.left = (SLOT_X[slotIdx] / 760 * levelStage.clientWidth) + "px";
  m.style.top  = (y / STAFF_EX.viewH * levelStage.clientHeight) + "px";
  levelStage.appendChild(m);
}

/* Tokens (uno a uno) */
function renderCurrentToken(){
  pool.innerHTML = "";
  if(tokenIdx >= target.length) return;

  const n = target[tokenIdx];
  const t = document.createElement("div");
  t.className = "token";
  t.dataset.note = n;

  t.innerHTML = `
    <svg viewBox="0 0 64 64" aria-hidden="true">
      <ellipse cx="28" cy="36" rx="12" ry="9" fill="#111" transform="rotate(-18 28 36)"/>
      <line x1="36" y1="34" x2="36" y2="8" stroke="#111" stroke-width="4" stroke-linecap="round"/>
    </svg>
    <div class="lbl">${n === "do2" ? "do‚Üë" : n}</div>
  `;

  // click: nota suelta (sin playhead)
  t.addEventListener("click", () => playNote(n, false).catch(console.error));

  t.addEventListener("pointerdown", (e) => {
    e.preventDefault();
    getAudioContext();

    const startRect = t.getBoundingClientRect();
    const ghost = t.cloneNode(true);
    ghost.style.position = "fixed";
    ghost.style.left = startRect.left + "px";
    ghost.style.top = startRect.top + "px";
    ghost.style.opacity = "0.75";
    ghost.style.zIndex = "9999";
    ghost.style.pointerEvents = "none";
    document.body.appendChild(ghost);

    let hoverSol = null;

    const move = (ev) => {
      ghost.style.left = (ev.clientX - startRect.width/2) + "px";
      ghost.style.top  = (ev.clientY - startRect.height/2) + "px";

      const r = levelStage.getBoundingClientRect();
      const inside = (ev.clientX >= r.left && ev.clientX <= r.right && ev.clientY >= r.top && ev.clientY <= r.bottom);
      if(!inside){
        showBand(null);
        hoverSol = null;
        return;
      }

      const relY = (ev.clientY - r.top) / r.height * STAFF_EX.viewH;
      hoverSol = nearestSolByY(relY);
      showBand(hoverSol);
    };

    const up = (ev) => {
      document.removeEventListener("pointermove", move);
      document.removeEventListener("pointerup", up);
      ghost.remove();
      showBand(null);

      const r = levelStage.getBoundingClientRect();
      const inside = (ev.clientX >= r.left && ev.clientX <= r.right && ev.clientY >= r.top && ev.clientY <= r.bottom);
      if(!inside) return;

      const slotIdx = tokenIdx;
      const relY = (ev.clientY - r.top) / r.height * STAFF_EX.viewH;
      const best = nearestSolByY(relY);

      const expected = target[slotIdx];

      if(best === expected){
        showBand(best, true);

        placed[slotIdx] = best;
        addPlacedNote(best, slotIdx);

        onCorrectPlacement();
        playNote(best, false).catch(console.error);

        tokenIdx++;
        renderCurrentToken();

        if(isComplete()) onComplete();
      }else{
        onWrongPlacement();
      }
    };

    document.addEventListener("pointermove", move, { passive:false });
    document.addEventListener("pointerup", up, { passive:false });
  });

  pool.appendChild(t);
}

/* ===================== Play note / sequence ===================== */
async function playNote(name, reference=false){
  stopPlayback();
  isPlaying = true;

  const kind = reference ? MODE : "black";
  const url = SAMPLES[name]?.[kind];
  if(!url) throw new Error("Falta sample para " + name + " (" + kind + ")");

  const buf = await loadBuffer(url);
  const ac = getAudioContext();
  const t0 = ac.currentTime + 0.03;

  const dur = playBufferAt(buf, t0, 1.0);

  setTimeout(() => { isPlaying = false; }, (dur * 1000) + 120);
}

async function playSequence(names, reference=false, slotXsForPlayhead=null){
  if(isPlaying) return;

  stopPlayback();
  isPlaying = true;

  const kind = reference ? MODE : "black";
  const urls = names.map(n => SAMPLES[n]?.[kind]).filter(Boolean);

  const buffers = [];
  for(const u of urls) buffers.push(await loadBuffer(u));

  const ac = getAudioContext();
  let t = ac.currentTime + 0.05;
  const GAP = 0.08;

  // ‚úÖ playhead SOLO en ejercicio (no referencia)
  if(!reference && slotXsForPlayhead){
    const durs = buffers.map(b => b.duration);
    schedulePlayheadSteps(slotXsForPlayhead, durs, GAP);
  }

  for(const buf of buffers){
    const d = playBufferAt(buf, t, 1.0);
    t += d + GAP;
  }

  const totalMs = (t - ac.currentTime) * 1000 + 160;
  setTimeout(() => { isPlaying = false; }, totalMs);
}

/* ===================== Nivel ===================== */
function startLevel(i){
  stopPlayback();

  levelIndex = i;
  target = LEVELS[levelIndex];
  placed = Array(target.length).fill(null);
  tokenIdx = 0;

  mistakes = 0;
  streak = 0;
  multiplier = 1;
  renderScore();

  lvlTitle.textContent = `Nivel ${levelIndex + 1}`;
  btnNext.disabled = true;
  setLockedState(false);

  clearLevelUI();
  renderCurrentToken();
}

/* ===================== Botones ===================== */
btnListen.addEventListener("click", () => {
  if(btnListen.disabled) return;
  playSequence(target, false, SLOT_X.slice(0, target.length)).catch(console.error);
});

btnChild.addEventListener("click", () => {
  if(btnChild.disabled) return;
  const current = placed.filter(Boolean);
  if(!current.length) return;
  playSequence(current, false, SLOT_X.slice(0, current.length)).catch(console.error);
});

btnNext.addEventListener("click", () => {
  if(btnNext.disabled) return;
  const next = levelIndex + 1;
  if(next < LEVELS.length) startLevel(next);
  else startLevel(0);
});

/* tocar nota colocada para o√≠rla (sin playhead) */
document.getElementById("lvlSvg").addEventListener("pointerdown", (e) => {
  if(!placed.some(Boolean)) return;

  const svg = document.getElementById("lvlSvg");
  const pt = svg.createSVGPoint();
  pt.x = e.clientX; pt.y = e.clientY;
  const ctm = svg.getScreenCTM();
  if(!ctm) return;
  const loc = pt.matrixTransform(ctm.inverse());

  let bestSlot = -1;
  let bestDx = Infinity;
  for(let i=0;i<SLOT_X.length;i++){
    const dx = Math.abs(SLOT_X[i] - loc.x);
    if(dx < bestDx){ bestDx = dx; bestSlot = i; }
  }
  if(bestSlot === -1 || bestDx > 40) return;

  const sol = placed[bestSlot];
  if(!sol) return;

  playNote(sol, false).catch(console.error);
});

startLevel(0);
</script>
</body>
</html>
