<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Partituras (arrastrar notas)</title>
  <style>
    :root{
      --bg:#10131a;
      --sheet:#ffffff;
      --ink:#0c0f14;
      --shadow: 0 14px 36px rgba(0,0,0,.35);
      --radius:18px;
      --gap:14px;

      --ok:#25c26e;
      --yellow: rgba(180, 140, 0, 0.38);
      --yellowStroke: rgba(130, 95, 0, 0.55);

      --btnBorder: rgba(0,0,0,.18);
      --btnShadow: 0 10px 22px rgba(0,0,0,.14);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 700px at 30% 10%, #20283a 0%, var(--bg) 60%, #070a11 100%);
      height:100vh;
      overflow:hidden;
    }

    .wrap{
      height:100vh;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--gap);
      padding: 14px;
    }

    .panel{
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height:0;
      display:flex;
      flex-direction:column;
    }

    .content{
      padding: 12px;
      overflow:auto;
      min-height:0;
    }

    .sheet{
      background: var(--sheet);
      border-radius: 16px;
      box-shadow: 0 10px 28px rgba(0,0,0,.18);
      border: 1px solid rgba(0,0,0,.08);
      overflow:hidden;
      position:relative;
    }

    .sheetInner{
      padding: 10px 10px 12px 10px;
      position:relative;
    }

    /* Big duration buttons (ONLY text allowed besides note names) */
    .durRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      padding: 12px;
    }
    .durBtn{
      height: 64px;
      border-radius: 16px;
      border: 2px solid var(--btnBorder);
      background: #fff;
      box-shadow: var(--btnShadow);
      cursor:pointer;
      user-select:none;
      font-weight: 900;
      letter-spacing: .8px;
      font-size: 18px;
      color: #111;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .durBtn.active{
      border-color: rgba(0,0,0,.55);
      box-shadow: 0 0 0 5px rgba(37,194,110,.18), var(--btnShadow);
    }

    .stage{
      position:relative;
      width:100%;
      max-width: 720px;
      margin: 0 auto;
    }

    svg.staff{
      width:100%;
      height:auto;
      display:block;
    }

    /* Reference note labels under notes */
    .refLabels text{
      font-weight: 900;
      font-size: 16px;
      fill: #111;
      letter-spacing: .2px;
    }

    /* Exercises */
    .exercise{
      margin-bottom: 12px;
    }

    /* two play buttons, no text */
    .playRow{
      display:flex;
      gap: 12px;
      justify-content:center;
      padding: 12px 12px 0 12px;
    }
    .playBtn{
      width: 74px;
      height: 54px;
      border-radius: 16px;
      border: 2px solid var(--btnBorder);
      background: #fff;
      box-shadow: var(--btnShadow);
      cursor:pointer;
      display:grid;
      place-items:center;
      user-select:none;
    }
    .playBtn svg{ display:block; }
    .playBtn.childOk{
      border-color: rgba(37,194,110,.75);
      box-shadow: 0 0 0 5px rgba(37,194,110,.20), var(--btnShadow);
    }

    /* Pool tokens: note symbol + name */
    .pool{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      padding: 12px;
      justify-content:center;
    }
    .noteToken{
      width:72px;
      height:78px;
      border-radius: 18px;
      background: #111;
      color: #fff;
      user-select:none;
      touch-action:none;
      cursor:grab;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
      border: 2px solid rgba(255,255,255,.12);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 6px;
      padding-top: 4px;
    }
    .noteToken:active{ cursor:grabbing; transform: translateY(1px); }
    .noteToken.locked{
      opacity:.28;
      cursor:default;
      filter: grayscale(.2);
      transform:none;
    }
    .noteName{
      font-weight: 900;
      font-size: 14px;
      letter-spacing: .3px;
      text-transform: lowercase;
      opacity: .95;
    }

    /* Green marker appears only after correct placement */
    .okMarker{
      position:absolute;
      width:40px; height:40px;
      border-radius: 12px;
      background: rgba(37,194,110,.18);
      border: 2px solid rgba(37,194,110,.65);
      box-shadow: 0 0 0 4px rgba(37,194,110,.12);
      pointer-events:none;
      transform: translate(-50%, -50%);
    }

    @media (max-width: 980px){
      body{ overflow:auto; }
      .wrap{ grid-template-columns: 1fr; height:auto; overflow:auto; }
    }
  </style>
</head>
<body>

<div class="wrap">

  <!-- LEFT: Reference -->
  <section class="panel">
    <div class="content">
      <div class="sheet">
        <div class="durRow">
          <button class="durBtn active" id="btnNegra">NEGRA</button>
          <button class="durBtn" id="btnBlanca">BLANCA</button>
        </div>

        <div class="sheetInner">
          <div class="stage">
            <svg class="staff" id="refSvg" viewBox="0 0 760 280" role="img" aria-label="Referencia">
              <!-- staff lines -->
              <g stroke="#111" stroke-width="2">
                <line x1="40" y1="80" x2="720" y2="80" />
                <line x1="40" y1="105" x2="720" y2="105" />
                <line x1="40" y1="130" x2="720" y2="130" />
                <line x1="40" y1="155" x2="720" y2="155" />
                <line x1="40" y1="180" x2="720" y2="180" />
              </g>

              <!-- clef -->
              <text x="54" y="155" font-size="56" fill="#111" font-weight="800">ùÑû</text>

              <g id="refNotes"></g>
              <g class="refLabels" id="refLabels"></g>
            </svg>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- RIGHT: Exercises -->
  <section class="panel">
    <div class="content" id="exerciseList"></div>
  </section>

</div>

<script>
  // ===================== AUDIO (offline) =====================
  let audioCtx = null;
  function ensureAudio(){
    if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if(audioCtx.state === "suspended") audioCtx.resume();
  }

  function playTone(freq, ms){
    try{
      ensureAudio();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = "sine";
      o.frequency.value = freq;

      const now = audioCtx.currentTime;
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(0.35, now + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, now + ms/1000);

      o.connect(g);
      g.connect(audioCtx.destination);
      o.start(now);
      o.stop(now + ms/1000 + 0.03);
    }catch(e){}
  }

  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }
  async function playSequence(freqs, noteMs, gapMs){
    for(const f of freqs){
      playTone(f, noteMs);
      await sleep(noteMs + gapMs);
    }
  }

  // ===================== SOLFEO + POSITIONS (clave de sol) =====================
  // Staff lines at y: 80,105,130,155,180. Bottom line y=180 is MI (E4).
  // RE is the space below that (floating). DO is ledger line below (short line only).
  const SOL_TO_FREQ = {
    do: 261.63,  // C4 (ledger)
    re: 293.66,  // D4 (space below)
    mi: 329.63,  // E4 (bottom line)
    fa: 349.23,  // F4 (space)
    sol:392.00,  // G4 (line)
    la: 440.00,  // A4 (space)
    si: 493.88,  // B4 (line)
    do5:523.25   // C5 (space)
  };

  // Vertical positions in this SVG (viewBox 760x280)
  const SOL_TO_Y = {
    do: 205,     // ledger line below staff
    re: 192.5,   // floating space below staff
    mi: 180,     // bottom line
    fa: 167.5,   // space
    sol:155,     // line
    la: 142.5,   // space
    si:130,      // line
    do5:117.5    // space
  };

  const BANDS = [
    {sol:"do",  y:SOL_TO_Y.do},
    {sol:"re",  y:SOL_TO_Y.re},
    {sol:"mi",  y:SOL_TO_Y.mi},
    {sol:"fa",  y:SOL_TO_Y.fa},
    {sol:"sol", y:SOL_TO_Y.sol},
    {sol:"la",  y:SOL_TO_Y.la},
    {sol:"si",  y:SOL_TO_Y.si},
    {sol:"do5", y:SOL_TO_Y.do5}
  ];

  function solDisplay(sol){
    return sol === "do5" ? "do" : sol;
  }

  // ===================== DURATIONS (doubled) =====================
  let mode = "negra";
  const NEGRA_MS = 640;   // doubled
  const BLANCA_MS = 2200; // doubled
  function curMs(){ return mode === "negra" ? NEGRA_MS : BLANCA_MS; }

  const btnNegra = document.getElementById("btnNegra");
  const btnBlanca = document.getElementById("btnBlanca");

  btnNegra.addEventListener("pointerdown", () => {
    ensureAudio();
    mode = "negra";
    btnNegra.classList.add("active");
    btnBlanca.classList.remove("active");
  });
  btnBlanca.addEventListener("pointerdown", () => {
    ensureAudio();
    mode = "blanca";
    btnBlanca.classList.add("active");
    btnNegra.classList.remove("active");
  });

  // ===================== SVG HELPERS =====================
  function svgEl(name){
    return document.createElementNS("http://www.w3.org/2000/svg", name);
  }

  // note drawing (black note with stem) + ledger line only for DO (C4)
  function drawNoteSVG(x, y, sol, clickable, onClick){
    const g = svgEl("g");
    g.setAttribute("transform", `translate(${x},${y})`);
    if(clickable){
      g.style.cursor = "pointer";
      g.addEventListener("pointerdown", (e) => { e.preventDefault(); onClick?.(); });
    }

    // ledger line ONLY for DO (C4): short line under note
    if(sol === "do"){
      const led = svgEl("line");
      led.setAttribute("x1", "-22");
      led.setAttribute("y1", "0");
      led.setAttribute("x2", "22");
      led.setAttribute("y2", "0");
      led.setAttribute("stroke", "#111");
      led.setAttribute("stroke-width", "2.2");
      led.setAttribute("stroke-linecap", "round");
      g.appendChild(led);
    }

    const head = svgEl("ellipse");
    head.setAttribute("cx","0");
    head.setAttribute("cy","0");
    head.setAttribute("rx","12");
    head.setAttribute("ry","9");
    head.setAttribute("fill","#111");
    head.setAttribute("transform","rotate(-18)");

    const stem = svgEl("line");
    stem.setAttribute("x1","10");
    stem.setAttribute("y1","-2");
    stem.setAttribute("x2","10");
    stem.setAttribute("y2","-50");
    stem.setAttribute("stroke","#111");
    stem.setAttribute("stroke-width","3");
    stem.setAttribute("stroke-linecap","round");

    g.appendChild(head);
    g.appendChild(stem);
    return g;
  }

  // yellow band highlight (only within staff area width; includes DO/RE zones below)
  function setBandHighlight(svg, yCenter){
    let layer = svg._bandLayer;
    if(!layer){
      layer = svgEl("g");
      layer.setAttribute("class","bandLayer");
      // Put it after staff lines (which are first) but before notes
      svg.insertBefore(layer, svg.querySelector(".placed") || svg.firstChild.nextSibling);
      svg._bandLayer = layer;
    }
    layer.innerHTML = "";
    if(yCenter == null) return;

    const laneH = 18;
    const x = 40, w = 680;

    // clamp vertically so it stays inside the staff drawing area (not outside the sheet)
    const topClamp = 65;     // just above top line
    const botClamp = 230;    // includes DO ledger area
    const y = Math.max(topClamp, Math.min(yCenter - laneH/2, botClamp - laneH));

    const rect = svgEl("rect");
    rect.setAttribute("x", String(x));
    rect.setAttribute("y", String(y));
    rect.setAttribute("width", String(w));
    rect.setAttribute("height", String(laneH));
    rect.setAttribute("rx", "6");
    rect.setAttribute("fill", "var(--yellow)");
    rect.setAttribute("stroke", "var(--yellowStroke)");
    rect.setAttribute("stroke-width", "1.2");
    layer.appendChild(rect);
  }

  function nearestBandFromViewBoxY(vby){
    let best = null, bestD = Infinity;
    for(const b of BANDS){
      const d = Math.abs(b.y - vby);
      if(d < bestD){ bestD = d; best = b; }
    }
    // tolerance
    return (bestD <= 14) ? best : null;
  }

  // ===================== LEFT: REFERENCE SCALE =====================
  (function renderReference(){
    const notesG = document.getElementById("refNotes");
    const labelsG = document.getElementById("refLabels");

    const scale = ["do","re","mi","fa","sol","la","si","do5"];
    const startX = 190;
    const stepX  = 70;

    scale.forEach((sol, i) => {
      const x = startX + stepX*i;
      const y = SOL_TO_Y[sol];

      notesG.appendChild(
        drawNoteSVG(x, y, sol, true, () => playTone(SOL_TO_FREQ[sol], curMs()))
      );

      const t = svgEl("text");
      t.setAttribute("x", String(x - 14));
      t.setAttribute("y", "265");
      t.textContent = solDisplay(sol);
      labelsG.appendChild(t);
    });
  })();

  // ===================== EXERCISES (soft -> harder) =====================
  const EXERCISES = [
    { id:"ex1",  target:["do","do","do"] },
    { id:"ex2",  target:["mi","mi","mi"] },
    { id:"ex3",  target:["re","re","re"] },
    { id:"ex4",  target:["do","mi","do"] },
    { id:"ex5",  target:["do","re","mi"] },
    { id:"ex6",  target:["mi","re","do"] },
    { id:"ex7",  target:["fa","fa","mi"] },
    { id:"ex8",  target:["sol","mi","re"] },
    { id:"ex9",  target:["la","sol","fa"] },
    { id:"ex10", target:["si","la","sol"] },
    { id:"ex11", target:["do5","si","la"] },
    { id:"ex12", target:["do","sol","do5"] }
  ];

  function shuffle(a){
    return a.map(v=>[Math.random(),v]).sort((x,y)=>x[0]-y[0]).map(p=>p[1]);
  }

  function playIcon(){
    return `
      <svg width="26" height="26" viewBox="0 0 24 24" aria-hidden="true">
        <path d="M8 5v14l12-7z" fill="#111"></path>
      </svg>
    `;
  }

  // Exercise staff viewBox uses same geometry as reference
  const SLOT_X = [320, 420, 520];

  // ===================== DRAG ENGINE =====================
  let drag = null;

  function startDrag(e, token, exState){
    if(token.classList.contains("locked")) return;
    ensureAudio();
    token.setPointerCapture(e.pointerId);

    const rect = token.getBoundingClientRect();
    const offsetX = e.clientX - rect.left;
    const offsetY = e.clientY - rect.top;

    // Ghost clone
    const ghost = token.cloneNode(true);
    ghost.style.position = "fixed";
    ghost.style.left = rect.left + "px";
    ghost.style.top = rect.top + "px";
    ghost.style.width = rect.width + "px";
    ghost.style.height = rect.height + "px";
    ghost.style.zIndex = 9999;
    ghost.style.cursor = "grabbing";
    ghost.style.transform = "none";
    document.body.appendChild(ghost);

    drag = { token, ghost, exState, pointerId: e.pointerId, offsetX, offsetY };

    window.addEventListener("pointermove", onMove, {passive:false});
    window.addEventListener("pointerup", onUp, {passive:false});
  }

  function onMove(e){
    if(!drag || e.pointerId !== drag.pointerId) return;
    e.preventDefault();

    drag.ghost.style.left = (e.clientX - drag.offsetX) + "px";
    drag.ghost.style.top  = (e.clientY - drag.offsetY) + "px";

    updateExerciseBandHighlight(drag.exState, e.clientX, e.clientY);
  }

  function updateExerciseBandHighlight(exState, clientX, clientY){
    const { stage, svg } = exState;
    const r = stage.getBoundingClientRect();
    const inside =
      clientX >= r.left && clientX <= r.right &&
      clientY >= r.top  && clientY <= r.bottom;

    if(!inside){
      setBandHighlight(svg, null);
      exState._hoverBand = null;
      return;
    }

    // Convert clientY to viewBox Y (viewBox height 280)
    const relY = (clientY - r.top) / r.height;
    const vby = relY * 280;

    const band = nearestBandFromViewBoxY(vby);
    if(!band){
      setBandHighlight(svg, null);
      exState._hoverBand = null;
      return;
    }
    setBandHighlight(svg, band.y);
    exState._hoverBand = band.sol;
  }

  function onUp(e){
    if(!drag || e.pointerId !== drag.pointerId) return;
    e.preventDefault();

    const { token, ghost, exState } = drag;
    const { stage, svg } = exState;

    // Clear highlight
    setBandHighlight(svg, null);

    const stageRect = stage.getBoundingClientRect();
    const ghostRect = ghost.getBoundingClientRect();
    const dropX = ghostRect.left + ghostRect.width/2;
    const dropY = ghostRect.top  + ghostRect.height/2;

    const inside =
      dropX >= stageRect.left && dropX <= stageRect.right &&
      dropY >= stageRect.top  && dropY <= stageRect.bottom;

    if(inside){
      const relY = (dropY - stageRect.top) / stageRect.height;
      const vby = relY * 280;

      const band = nearestBandFromViewBoxY(vby);
      if(band){
        const solDragged = token.dataset.sol;
        const nextIndex = exState.placed.findIndex(x => x == null);

        if(nextIndex !== -1){
          const expected = exState.target[nextIndex];

          // Correct if:
          // 1) dragged note matches expected slot
          // 2) drop height band matches that note
          if(solDragged === expected && band.sol === solDragged){
            const x = SLOT_X[nextIndex];
            const y = SOL_TO_Y[solDragged];

            exState.placed[nextIndex] = solDragged;

            // Draw note on staff
            exState.placedG.appendChild(drawNoteSVG(x, y, solDragged, false));

            // Green marker (where the note is)
            showMarker(exState, x, y);

            // Lock token
            token.classList.add("locked");

            // Sound (only note)
            playTone(SOL_TO_FREQ[solDragged], curMs());

            // Update child play green state
            updateChildPlayState(exState);
          }else{
            // Wrong
            playTone(196.00, 160);
          }
        }else{
          playTone(196.00, 100);
        }
      }else{
        playTone(196.00, 100);
      }
    }else{
      playTone(196.00, 80);
    }

    ghost.remove();
    window.removeEventListener("pointermove", onMove);
    window.removeEventListener("pointerup", onUp);
    drag = null;
  }

  function showMarker(exState, vbx, vby){
    const r = exState.stage.getBoundingClientRect();
    const px = (vbx / 760) * r.width;
    const py = (vby / 280) * r.height;

    const m = document.createElement("div");
    m.className = "okMarker";
    m.style.left = px + "px";
    m.style.top  = py + "px";
    exState.markerLayer.appendChild(m);
  }

  function updateChildPlayState(exState){
    const ok =
      exState.placed.every(v => v != null) &&
      exState.placed.join("|") === exState.target.join("|");
    if(ok) exState.btnChild.classList.add("childOk");
    else exState.btnChild.classList.remove("childOk");
  }

  function getTargetFreqs(exState){
    return exState.target.map(sol => SOL_TO_FREQ[sol]);
  }
  function getChildFreqs(exState){
    return exState.placed.filter(Boolean).map(sol => SOL_TO_FREQ[sol]);
  }

  // ===================== BUILD EXERCISE =====================
  function makeExercise(ex){
    const wrapper = document.createElement("div");
    wrapper.className = "exercise";

    const sheet = document.createElement("div");
    sheet.className = "sheet";

    // Play buttons row (no text)
    const playRow = document.createElement("div");
    playRow.className = "playRow";

    const btnTarget = document.createElement("button");
    btnTarget.className = "playBtn";
    btnTarget.innerHTML = playIcon();

    const btnChild = document.createElement("button");
    btnChild.className = "playBtn";
    btnChild.innerHTML = playIcon();

    playRow.appendChild(btnTarget);
    playRow.appendChild(btnChild);

    // Staff
    const inner = document.createElement("div");
    inner.className = "sheetInner";

    const stage = document.createElement("div");
    stage.className = "stage";

    const svg = svgEl("svg");
    svg.setAttribute("class","staff");
    svg.setAttribute("viewBox","0 0 760 280");
    svg.innerHTML = `
      <g stroke="#111" stroke-width="2">
        <line x1="40" y1="80" x2="720" y2="80" />
        <line x1="40" y1="105" x2="720" y2="105" />
        <line x1="40" y1="130" x2="720" y2="130" />
        <line x1="40" y1="155" x2="720" y2="155" />
        <line x1="40" y1="180" x2="720" y2="180" />
      </g>
      <text x="54" y="155" font-size="56" fill="#111" font-weight="800">ùÑû</text>
      <g class="placed"></g>
    `;
    stage.appendChild(svg);

    const markerLayer = document.createElement("div");
    markerLayer.style.position="absolute";
    markerLayer.style.left="0";
    markerLayer.style.top="0";
    markerLayer.style.right="0";
    markerLayer.style.bottom="0";
    markerLayer.style.pointerEvents="none";
    stage.appendChild(markerLayer);

    inner.appendChild(stage);

    // Pool tokens: note symbol + name (do/re/mi...)
    const pool = document.createElement("div");
    pool.className = "pool";

    // pool contains exactly the notes needed, shuffled
    const poolNotes = shuffle(ex.target.slice());
    poolNotes.forEach((sol) => {
      const token = document.createElement("div");
      token.className = "noteToken";
      token.dataset.sol = sol;

      // Note icon (stem note)
      const icon = document.createElement("div");
      icon.innerHTML = `
        <svg width="28" height="28" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M14 3v10.4a3.6 3.6 0 1 1-2-3.2V5.2l8-2.2V13a3.6 3.6 0 1 1-2-3.2V3z" fill="#fff"/>
        </svg>
      `;

      const name = document.createElement("div");
      name.className = "noteName";
      name.textContent = solDisplay(sol);

      token.appendChild(icon);
      token.appendChild(name);

      // Click/tap plays ONLY the note (no click sound)
      token.addEventListener("click", () => playTone(SOL_TO_FREQ[sol], curMs()));

      pool.appendChild(token);
    });

    // State
    const exState = {
      id: ex.id,
      target: ex.target.slice(),
      placed: [null, null, null],
      stage,
      svg,
      placedG: svg.querySelector(".placed"),
      markerLayer,
      btnTarget,
      btnChild
    };

    // Bind drag for each token
    Array.from(pool.children).forEach(tok => {
      tok.addEventListener("pointerdown", (e) => startDrag(e, tok, exState));
    });

    // Play objective: 30% faster gaps (less silence)
    const baseGap = 140;
    const targetGap = Math.round(baseGap * 0.70);

    btnTarget.addEventListener("pointerdown", async () => {
      ensureAudio();
      await playSequence(getTargetFreqs(exState), curMs(), targetGap);
    });

    // Play child: normal gap
    btnChild.addEventListener("pointerdown", async () => {
      ensureAudio();
      await playSequence(getChildFreqs(exState), curMs(), baseGap);
      updateChildPlayState(exState);
    });

    sheet.appendChild(playRow);
    sheet.appendChild(inner);
    sheet.appendChild(pool);
    wrapper.appendChild(sheet);

    return wrapper;
  }

  // ===================== RENDER EXERCISES =====================
  (function renderExercises(){
    const list = document.getElementById("exerciseList");
    list.innerHTML = "";
    EXERCISES.forEach(ex => list.appendChild(makeExercise(ex)));
  })();
</script>

</body>
</html>
