<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Lectura musical</title>

<style>
:root{
  --bg:#10131a;
  --shadow:0 14px 36px rgba(0,0,0,.35);
  --yellow:rgba(180,140,0,.35);
  --ok:#25c26e;
  --card:rgba(255,255,255,.06);
}

*{box-sizing:border-box}
body{
  margin:0;
  background:radial-gradient(1200px 700px at 30% 10%, #20283a 0%, var(--bg) 60%, #070a11 100%);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
  min-height:100vh;
}
.wrap{
  width:min(980px, 100%);
  margin:0 auto;
  padding:14px;
  display:grid;
  gap:14px;
}
.panel{
  background:var(--card);
  border-radius:18px;
  box-shadow:var(--shadow);
  overflow:hidden;
}
.rowTop{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding:14px;
}
.title{
  color:#fff;
  font-weight:900;
  margin:0;
  font-size:18px;
  letter-spacing:.3px;
  user-select:none;
}

/* CONTROLES (ahora entre pentagramas) */
.controlsBar{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  flex-wrap:wrap;
  padding:12px 14px 14px;
}
.controls{
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:center;
  flex-wrap:wrap;
}

.ctrlBtn{
  width:56px;height:46px;border-radius:14px;
  border:2px solid rgba(255,255,255,.35);
  background:rgba(255,255,255,.06);
  color:#fff;
  cursor:pointer;
  font-weight:900;
  transition:.12s;
}
.ctrlBtn:hover{ background:rgba(255,255,255,.10); }
.ctrlBtn:active{ transform:scale(.98); }
.ctrlBtn[disabled]{ opacity:.28; cursor:not-allowed; }

.modeBtn{
  width:72px;
  background:#fff;
  color:#111;
  border-color:#bbb;
}
.modeBtn.active{
  box-shadow:0 0 0 4px rgba(37,194,110,.20);
  border-color:rgba(37,194,110,.6);
}

/* Play del alumno: rojo -> verde cuando 4/4 */
.childBtn{
  border-color:#c0392b;
  background:#ffecec;
  color:#111;
}
.childBtn:hover{ background:#ffdede; }
.childBtn.ok{
  border-color: var(--ok);
  background:#eafff1;
}
.childBtn.ok:hover{ background:#dbffea; }

/* estrellas */
.starBox{
  min-width:86px;
  text-align:center;
  font-size:20px;
  letter-spacing:2px;
  user-select:none;
  filter:drop-shadow(0 6px 10px rgba(0,0,0,.25));
}
.starBox .on{ color:#ffd54a; }
.starBox .off{ color:rgba(255,255,255,.35); }

.sheet{
  background:#fff;
  border-radius:16px;
  padding:12px;
  margin:14px;
}
.stage{ position:relative; }
svg{ width:100%; height:auto; display:block; }

/* ref m√°s peque√±o */
.refWrap{
  width:60%;
  margin:0 auto;
}

.pool{
  display:flex;
  justify-content:center;
  gap:14px;
  margin:10px 14px 16px;
  flex-wrap:wrap;
  min-height:100px;
}

/* ‚úÖ tokens ya NO ‚Äúrecuadro‚Äù: forma tipo ‚Äúficha redonda‚Äù con nota */
.token{
  width:88px;height:96px;
  border-radius:999px;
  background:rgba(10,12,18,.92);
  color:#fff;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:center;
  gap:6px;
  cursor:grab;
  user-select:none;
  touch-action:none;
  box-shadow:0 10px 18px rgba(0,0,0,.25);
  border:1px solid rgba(255,255,255,.14);
}
.token.locked{ opacity:.28; cursor:default; }
.token svg{ width:34px; height:34px; display:block; }
.token .lbl{ font-weight:900; font-size:14px; letter-spacing:.3px; opacity:.95; }

/* marcador verde */
.marker{
  position:absolute;
  width:38px;height:38px;border-radius:12px;
  background:rgba(37,194,110,.25);
  border:2px solid rgba(37,194,110,.7);
  transform:translate(-50%,-50%);
  pointer-events:none;
}

/* Altavoz overlay */
.speaker{
  position:absolute;
  inset:0;
  display:grid;
  place-items:center;
  pointer-events:none;
  opacity:0;
  transition:opacity .15s ease;
}
.speaker.show{ opacity:1; }
.speaker .bubble{
  width:120px;height:120px;border-radius:32px;
  background:rgba(255,255,255,.88);
  box-shadow:var(--shadow);
  display:grid;
  place-items:center;
  backdrop-filter:blur(6px);
}
.speaker svg{ width:66px;height:66px; }

/* banda amarilla "flash" al acertar */
.bandFlash{
  animation: bandFlash .22s ease-in-out 0s 2;
}
@keyframes bandFlash{
  0%   { opacity:1; transform:scaleX(1); }
  50%  { opacity:.25; transform:scaleX(.98); }
  100% { opacity:1; transform:scaleX(1); }
}

.hintBar{
  height:8px;
  width:100%;
  background:rgba(255,255,255,.08);
}

/* ‚úÖ playhead vertical (barra que avanza) */
.playhead{
  position:absolute;
  top:16px;
  bottom:16px;
  width:4px;
  border-radius:999px;
  background:rgba(255,60,60,.95);
  box-shadow:0 10px 18px rgba(0,0,0,.25);
  pointer-events:none;
  opacity:0;
  transform:translateX(-2px);
}
.playhead.show{ opacity:1; }
</style>
</head>

<body>
  <div class="wrap">
    <div class="panel">

      <!-- CABECERA (solo t√≠tulo arriba) -->
      <div class="rowTop">
        <p class="title" id="lvlTitle">Nivel 1</p>
      </div>
      <div class="hintBar"></div>

      <!-- ARRIBA: REFERENCIA -->
      <div class="sheet">
        <div class="stage refWrap" id="refStage">
          <svg viewBox="0 0 760 260" id="refSvg" aria-label="Escala de referencia">
            <g stroke="#000" stroke-width="2">
              <line x1="40" y1="60"  x2="720" y2="60"/>
              <line x1="40" y1="85"  x2="720" y2="85"/>
              <line x1="40" y1="110" x2="720" y2="110"/>
              <line x1="40" y1="135" x2="720" y2="135"/>
              <line x1="40" y1="160" x2="720" y2="160"/>
            </g>
            <text x="54" y="135" font-size="56">ùÑû</text>

            <g id="refNotes"></g>
            <g id="refNames"></g>
          </svg>

          <div class="speaker" id="speakerRef" aria-hidden="true">
            <div class="bubble">
              <svg viewBox="0 0 64 64" fill="none">
                <path d="M28 22L18 30H10v4h8l10 8V22z" fill="#111827"/>
                <path d="M40 24c3 3 3 13 0 16" stroke="#4aa3ff" stroke-width="4" stroke-linecap="round"/>
                <path d="M48 18c6 6 6 22 0 28" stroke="#4aa3ff" stroke-width="4" stroke-linecap="round" opacity=".75"/>
              </svg>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚úÖ CONTROLES ENTRE PENTAGRAMAS -->
      <div class="controlsBar" aria-label="Controles">
        <div class="starBox" id="stars" aria-label="Estrellas">
          <span class="on">‚òÖ</span><span class="on">‚òÖ</span><span class="on">‚òÖ</span>
        </div>

        <div class="controls">
          <!-- Modo duraci√≥n SOLO PARA REFERENCIA -->
          <button class="ctrlBtn modeBtn active" id="btnNegra" aria-label="Referencia negra">N</button>
          <button class="ctrlBtn modeBtn" id="btnBlanca" aria-label="Referencia blanca">B</button>

          <!-- Escuchar objetivo -->
          <button class="ctrlBtn" id="btnListen" aria-label="Escuchar objetivo">‚ñ∂</button>

          <!-- Escuchar lo que llevo -->
          <button class="ctrlBtn childBtn" id="btnChild" aria-label="Escuchar lo que llevo">‚ñ∂</button>

          <!-- Siguiente -->
          <button class="ctrlBtn" id="btnNext" aria-label="Siguiente" disabled>‚Üí</button>
        </div>
      </div>

      <!-- ABAJO: EJERCICIO -->
      <div class="sheet">
        <div class="stage" id="levelStage">
          <div class="playhead" id="playhead" aria-hidden="true"></div>

          <svg viewBox="0 0 760 280" id="lvlSvg" aria-label="Pentagrama del nivel">
            <g stroke="#000" stroke-width="2">
              <line x1="40" y1="80"  x2="720" y2="80"/>
              <line x1="40" y1="105" x2="720" y2="105"/>
              <line x1="40" y1="130" x2="720" y2="130"/>
              <line x1="40" y1="155" x2="720" y2="155"/>
              <line x1="40" y1="180" x2="720" y2="180"/>
            </g>
            <text x="54" y="155" font-size="56">ùÑû</text>

            <!-- banda amarilla -->
            <g id="bandG"></g>

            <!-- notas colocadas -->
            <g id="placedG"></g>
          </svg>

          <div class="speaker" id="speakerLvl" aria-hidden="true">
            <div class="bubble">
              <svg viewBox="0 0 64 64" fill="none">
                <path d="M28 22L18 30H10v4h8l10 8V22z" fill="#111827"/>
                <path d="M40 24c3 3 3 13 0 16" stroke="#4aa3ff" stroke-width="4" stroke-linecap="round"/>
                <path d="M48 18c6 6 6 22 0 28" stroke="#4aa3ff" stroke-width="4" stroke-linecap="round" opacity=".75"/>
              </svg>
            </div>
          </div>
        </div>

        <div class="pool" id="pool" aria-label="Fichas"></div>
      </div>

    </div>
  </div>

<script>
/* ===================== AUDIO ===================== */
const AUDIO_FOLDER = ""; // <-- CAMBIA AQU√ç si los mp3 est√°n en una carpeta
const SAMPLES = {
  do:  { white: AUDIO_FOLDER + "do_blanca.mp3",  black: AUDIO_FOLDER + "do_negra.mp3"  },
  re:  { white: AUDIO_FOLDER + "re_blanca.mp3",  black: AUDIO_FOLDER + "re_negra.mp3"  },
  mi:  { white: AUDIO_FOLDER + "mi_blanca.mp3",  black: AUDIO_FOLDER + "mi_negra.mp3"  },
  fa:  { white: AUDIO_FOLDER + "fa_blanca.mp3",  black: AUDIO_FOLDER + "fa_negra.mp3"  },
  sol: { white: AUDIO_FOLDER + "sol_blanca.mp3", black: AUDIO_FOLDER + "sol_negra.mp3" },
  la:  { white: AUDIO_FOLDER + "la_blanca.mp3",  black: AUDIO_FOLDER + "la_negra.mp3"  },
  si:  { white: AUDIO_FOLDER + "si_blanca.mp3",  black: AUDIO_FOLDER + "si_negra.mp3"  },
};

const SCALE = ["do","re","mi","fa","sol","la","si"];

/* ===================== MAPEO CLAVADO ===================== */
const STAFF_EX = { top: 80, bottom: 180, lineGap: 25, viewH: 280 };
const STAFF_REF = { top: 60, bottom: 160, lineGap: 25, viewH: 260 };

// offsets en "pasos" respecto a MI (mi=0)
const OFF = { do:+2, re:+1, mi:0, fa:-1, sol:-2, la:-3, si:-4 };

function yFor(note, staff){
  const step = staff.lineGap / 2;
  return staff.bottom + OFF[note] * step;
}
function ledgerLinesRelY(noteY, staff){
  const lines = [];
  const top = staff.top, bottom = staff.bottom, gap = staff.lineGap;

  if(noteY > bottom){
    const n = Math.floor((noteY - bottom) / gap + 1e-6);
    for(let i=1;i<=n;i++){
      const yLine = bottom + i*gap;
      lines.push(yLine - noteY);
    }
  }
  if(noteY < top){
    const n = Math.floor((top - noteY) / gap + 1e-6);
    for(let i=1;i<=n;i++){
      const yLine = top - i*gap;
      lines.push(yLine - noteY);
    }
  }
  return lines;
}
function ledgerLinesSVG(relYs){
  if(!relYs.length) return "";
  return relYs.map(ry =>
    `<line x1="-22" y1="${ry}" x2="22" y2="${ry}" stroke="#000" stroke-width="2"/>`
  ).join("");
}
function noteSVG(x, y, staff){
  const rels = ledgerLinesRelY(y, staff);
  return `
  <g class="placedNote" transform="translate(${x},${y})">
    ${ledgerLinesSVG(rels)}
    <ellipse rx="12" ry="9" fill="#000" transform="rotate(-18)"/>
    <line x1="10" y1="-2" x2="10" y2="-50" stroke="#000" stroke-width="3"/>
  </g>`;
}
const MAP_EX = Object.fromEntries(SCALE.map(n => [n, { y: yFor(n, STAFF_EX) }]));

/* ===================== AUDIO ENGINE ===================== */
let ctx = null;
let isPlaying = false;
let activeSources = [];
const bufferCache = new Map();

function getAudioContext(){
  if(!ctx) ctx = new (window.AudioContext || window.webkitAudioContext)();
  if(ctx.state === "suspended") ctx.resume();
  return ctx;
}
async function loadBuffer(url){
  if(bufferCache.has(url)) return bufferCache.get(url);
  const res = await fetch(url);
  if(!res.ok) throw new Error("No se pudo cargar: " + url);
  const arr = await res.arrayBuffer();
  const ac = getAudioContext();
  const buf = await ac.decodeAudioData(arr);
  bufferCache.set(url, buf);
  return buf;
}
function stopPlayback(){
  activeSources.forEach(s => { try{ s.stop(0); }catch(e){} });
  activeSources = [];
  isPlaying = false;
  hideSpeakerAll();
  stopPlayhead();
}
function playBufferAt(buffer, startTime, gainValue=1.0){
  const ac = getAudioContext();
  const src = ac.createBufferSource();
  const gain = ac.createGain();
  src.buffer = buffer;
  gain.gain.setValueAtTime(gainValue, startTime);
  src.connect(gain).connect(ac.destination);
  activeSources.push(src);
  src.onended = () => { activeSources = activeSources.filter(x => x !== src); };
  src.start(startTime);
  return buffer.duration;
}

/* ===================== Modo duraci√≥n (solo referencia) ===================== */
let MODE = "black";
const btnNegra = document.getElementById("btnNegra");
const btnBlanca = document.getElementById("btnBlanca");
btnNegra.addEventListener("click", () => {
  MODE = "black";
  btnNegra.classList.add("active");
  btnBlanca.classList.remove("active");
});
btnBlanca.addEventListener("click", () => {
  MODE = "white";
  btnBlanca.classList.add("active");
  btnNegra.classList.remove("active");
});

/* ===================== Speakers ===================== */
const speakerRef = document.getElementById("speakerRef");
const speakerLvl = document.getElementById("speakerLvl");
function showSpeaker(el){ el.classList.add("show"); }
function hideSpeaker(el){ el.classList.remove("show"); }
function hideSpeakerAll(){ hideSpeaker(speakerRef); hideSpeaker(speakerLvl); }

/* ===================== ‚úÖ Playhead (barra que avanza) ===================== */
const levelStage = document.getElementById("levelStage");
const playhead = document.getElementById("playhead");
let playheadRAF = null;
let playheadT0 = 0;
let playheadDur = 0;

function stopPlayhead(){
  if(playheadRAF) cancelAnimationFrame(playheadRAF);
  playheadRAF = null;
  playhead.classList.remove("show");
}
function startPlayhead(totalSeconds){
  stopPlayhead();
  if(!totalSeconds || totalSeconds <= 0) return;

  const xStart = 40;
  const xEnd = 720;

  playheadT0 = performance.now();
  playheadDur = totalSeconds * 1000;
  playhead.classList.add("show");

  const tick = () => {
    const now = performance.now();
    const t = Math.min(1, (now - playheadT0) / playheadDur);
    const x = xStart + (xEnd - xStart) * t;

    // convertir x del viewBox (760) a px dentro del stage
    const px = (x / 760) * levelStage.clientWidth;
    playhead.style.left = px + "px";

    if(t < 1){
      playheadRAF = requestAnimationFrame(tick);
    }else{
      stopPlayhead();
    }
  };
  playheadRAF = requestAnimationFrame(tick);
}

/* ===================== Play note / sequence ===================== */
async function playNote(name, speakerEl, reference=false){
  stopPlayback();
  isPlaying = true;
  showSpeaker(speakerEl);

  const kind = reference ? MODE : "black";
  const url = SAMPLES[name]?.[kind];
  if(!url) throw new Error("Falta sample para " + name + " (" + kind + ")");

  const buf = await loadBuffer(url);
  const ac = getAudioContext();
  const t0 = ac.currentTime + 0.03;

  // ‚úÖ playhead (nota suelta)
  startPlayhead(buf.duration + 0.08);

  const dur = playBufferAt(buf, t0, 1.0);

  setTimeout(() => {
    hideSpeaker(speakerEl);
    isPlaying = false;
  }, (dur * 1000) + 120);
}

async function playSequence(names, speakerEl, reference=false){
  if(isPlaying) return;

  stopPlayback();
  isPlaying = true;
  showSpeaker(speakerEl);

  const kind = reference ? MODE : "black";
  const urls = names.map(n => SAMPLES[n]?.[kind]).filter(Boolean);

  const buffers = [];
  for(const u of urls) buffers.push(await loadBuffer(u));

  const ac = getAudioContext();
  let t = ac.currentTime + 0.05;
  const GAP = 0.08;

  // ‚úÖ calcular duraci√≥n total real para playhead
  const totalSec = buffers.reduce((acc,b)=>acc + b.duration, 0) + (Math.max(0, buffers.length - 1) * GAP) + 0.10;
  startPlayhead(totalSec);

  for(const buf of buffers){
    const d = playBufferAt(buf, t, 1.0);
    t += d + GAP;
  }

  const totalMs = (t - ac.currentTime) * 1000 + 160;
  setTimeout(() => {
    hideSpeaker(speakerEl);
    isPlaying = false;
  }, totalMs);
}

/* ===================== Referencia: notas + nombres ===================== */
const refNotes = document.getElementById("refNotes");
const refNames = document.getElementById("refNames");

SCALE.forEach((s,i)=>{
  const x = 170 + i*80;
  const y = yFor(s, STAFF_REF);

  const g = document.createElementNS("http://www.w3.org/2000/svg","g");
  g.innerHTML = noteSVG(x, y, STAFF_REF);
  g.style.cursor = "pointer";
  g.addEventListener("pointerdown", (e) => {
    e.preventDefault();
    playNote(s, speakerRef, true).catch(console.error);
  });
  refNotes.appendChild(g);

  refNames.insertAdjacentHTML("beforeend",
    `<text x="${x-14}" y="248" font-size="16" font-weight="900">${s}</text>`
  );
});

/* ===================== Niveles ===================== */
const LEVELS = [
  ["do","re","mi","sol"],
  ["do","mi","sol","fa"],
  ["re","mi","fa","sol"],
  ["mi","re","do","sol"],
  ["sol","fa","mi","re"],
  ["do","re","fa","sol"],
  ["re","fa","sol","la"],
  ["mi","fa","sol","la"],
  ["sol","la","si","do"],
  ["la","si","do","re"],
];

const lvlTitle = document.getElementById("lvlTitle");
const btnListen = document.getElementById("btnListen");
const btnChild  = document.getElementById("btnChild");
const btnNext   = document.getElementById("btnNext");

const bandG = document.getElementById("bandG");
const placedG = document.getElementById("placedG");
const pool = document.getElementById("pool");

/* ‚úÖ Estrellas */
const starsEl = document.getElementById("stars");
let stars = 3;               // 0..3
const STAR_MAX = 3;
function renderStars(){
  const on = stars;
  let html = "";
  for(let i=0;i<STAR_MAX;i++){
    html += `<span class="${i<on ? "on":"off"}">${i<on ? "‚òÖ":"‚òÖ"}</span>`;
  }
  starsEl.innerHTML = html;
}
function penalizeStar(){
  stars = Math.max(0, stars - 1);
  renderStars();
}

let levelIndex = 0;
let target = null;
let placed = [];
let tokenIdx = 0;

const SLOT_X = [300, 390, 480, 570];

function showBand(sol, flash=false){
  bandG.innerHTML = "";
  if(!sol) return;

  const y = MAP_EX[sol].y;
  const rect = document.createElementNS("http://www.w3.org/2000/svg","rect");
  rect.setAttribute("x","40");
  rect.setAttribute("y", String(y - 9));
  rect.setAttribute("width","680");
  rect.setAttribute("height","18");
  rect.setAttribute("rx","6");
  rect.setAttribute("fill", getComputedStyle(document.documentElement).getPropertyValue("--yellow").trim() || "rgba(180,140,0,.35)");
  if(flash) rect.classList.add("bandFlash");
  bandG.appendChild(rect);
}
function nearestSolByY(y){
  let best=null, bestD=Infinity;
  for(const k of SCALE){
    const d = Math.abs(MAP_EX[k].y - y);
    if(d < bestD){ bestD=d; best=k; }
  }
  return best;
}

function clearLevelUI(){
  placedG.innerHTML = "";
  bandG.innerHTML = "";
  levelStage.querySelectorAll(".marker").forEach(m => m.remove());
  pool.innerHTML = "";
  btnChild.classList.remove("ok");
  stopPlayhead();
}

function setLockedState(locked){
  btnListen.disabled = locked;
  btnChild.disabled  = locked;
  btnNegra.disabled  = locked;
  btnBlanca.disabled = locked;
}

function isComplete(){
  return placed.length === target.length && placed.join("|") === target.join("|");
}

/* ‚úÖ Al completar: bloqueamos TODO menos el bot√≥n verde (btnChild) */
function onComplete(){
  btnNext.disabled = false;

  // bloquea el resto
  setLockedState(true);

  // pero deja btnChild SIEMPRE disponible para escuchar lo producido
  btnChild.disabled = false;
  btnChild.classList.add("ok");
}

function addPlacedNote(sol, slotIdx){
  const y = MAP_EX[sol].y;

  placedG.insertAdjacentHTML("beforeend",
    noteSVG(SLOT_X[slotIdx], y, STAFF_EX)
  );

  const m = document.createElement("div");
  m.className = "marker";
  m.style.left = (SLOT_X[slotIdx] / 760 * levelStage.clientWidth) + "px";
  m.style.top  = (y / STAFF_EX.viewH * levelStage.clientHeight) + "px";
  levelStage.appendChild(m);
}

function renderCurrentToken(){
  pool.innerHTML = "";
  if(tokenIdx >= target.length) return;

  const n = target[tokenIdx];
  const t = document.createElement("div");
  t.className = "token";
  t.dataset.note = n;

  t.innerHTML = `
    <svg viewBox="0 0 24 24" aria-hidden="true">
      <path d="M14 3v10.4a3.6 3.6 0 1 1-2-3.2V5.2l8-2.2V13a3.6 3.6 0 1 1-2-3.2V3z" fill="#fff"/>
    </svg>
    <div class="lbl">${n}</div>
  `;

  // click: o√≠r la nota suelta (negra)
  t.addEventListener("click", () => playNote(n, speakerLvl, false).catch(console.error));

  // drag & drop
  t.addEventListener("pointerdown", (e) => {
    e.preventDefault();
    getAudioContext();

    const startRect = t.getBoundingClientRect();
    const ghost = t.cloneNode(true);
    ghost.style.position = "fixed";
    ghost.style.left = startRect.left + "px";
    ghost.style.top = startRect.top + "px";
    ghost.style.opacity = "0.75";
    ghost.style.zIndex = "9999";
    ghost.style.pointerEvents = "none";
    document.body.appendChild(ghost);

    let hoverSol = null;

    const move = (ev) => {
      ghost.style.left = (ev.clientX - startRect.width/2) + "px";
      ghost.style.top  = (ev.clientY - startRect.height/2) + "px";

      const r = levelStage.getBoundingClientRect();
      const inside = (ev.clientX >= r.left && ev.clientX <= r.right && ev.clientY >= r.top && ev.clientY <= r.bottom);
      if(!inside){
        showBand(null);
        hoverSol = null;
        return;
      }

      const relY = (ev.clientY - r.top) / r.height * STAFF_EX.viewH;
      hoverSol = nearestSolByY(relY);
      showBand(hoverSol);
    };

    const up = (ev) => {
      document.removeEventListener("pointermove", move);
      document.removeEventListener("pointerup", up);
      ghost.remove();
      showBand(null);

      const r = levelStage.getBoundingClientRect();
      const inside = (ev.clientX >= r.left && ev.clientX <= r.right && ev.clientY >= r.top && ev.clientY <= r.bottom);
      if(!inside) return;

      const slotIdx = tokenIdx;
      const relY = (ev.clientY - r.top) / r.height * STAFF_EX.viewH;
      const best = nearestSolByY(relY);

      const expected = target[slotIdx];

      if(best === expected){
        showBand(best, true);

        placed[slotIdx] = best;
        addPlacedNote(best, slotIdx);

        playNote(best, speakerLvl, false).catch(console.error);

        tokenIdx++;
        renderCurrentToken();

        if(isComplete()){
          onComplete();
        }
      }else{
        // ‚úÖ penalizaci√≥n por fallo (estrella)
        penalizeStar();
      }
    };

    document.addEventListener("pointermove", move, { passive:false });
    document.addEventListener("pointerup", up, { passive:false });
  });

  pool.appendChild(t);
}

function startLevel(i){
  stopPlayback();

  levelIndex = i;
  target = LEVELS[levelIndex];
  placed = Array(target.length).fill(null);
  tokenIdx = 0;

  // ‚úÖ reset estrellas por nivel
  stars = STAR_MAX;
  renderStars();

  lvlTitle.textContent = `Nivel ${levelIndex + 1}`;
  btnNext.disabled = true;
  setLockedState(false);

  clearLevelUI();
  renderCurrentToken();
}

btnListen.addEventListener("click", () => {
  if(btnListen.disabled) return;
  playSequence(target, speakerLvl, false).catch(console.error);
});

btnChild.addEventListener("click", () => {
  if(btnChild.disabled) return;
  const current = placed.filter(Boolean);
  // si no hay nada puesto a√∫n, no hacemos play
  if(!current.length) return;
  playSequence(current, speakerLvl, false).catch(console.error);
});

btnNext.addEventListener("click", () => {
  if(btnNext.disabled) return;
  const next = levelIndex + 1;
  if(next < LEVELS.length) startLevel(next);
  else startLevel(0);
});

// tocar nota colocada para o√≠rla
document.getElementById("lvlSvg").addEventListener("pointerdown", (e) => {
  if(!placed.some(Boolean)) return;

  const svg = document.getElementById("lvlSvg");
  const pt = svg.createSVGPoint();
  pt.x = e.clientX; pt.y = e.clientY;
  const ctm = svg.getScreenCTM();
  if(!ctm) return;
  const loc = pt.matrixTransform(ctm.inverse());

  let bestSlot = -1;
  let bestDx = Infinity;
  for(let i=0;i<SLOT_X.length;i++){
    const dx = Math.abs(SLOT_X[i] - loc.x);
    if(dx < bestDx){ bestDx = dx; bestSlot = i; }
  }
  if(bestSlot === -1 || bestDx > 40) return;

  const sol = placed[bestSlot];
  if(!sol) return;

  playNote(sol, speakerLvl, false).catch(console.error);
});

startLevel(0);
</script>
</body>
</html>
